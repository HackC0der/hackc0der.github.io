<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="HackC0der">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://HackC0der.github.io/2025/12/29/linux-kernel-pwn（一）基础知识/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux Kernel PWN">
<meta property="og:url" content="https://hackc0der.github.io/2025/12/29/Linux-Kernel-PWN%EF%BC%88%E4%B8%80%EF%BC%89%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hackc0der.github.io/images/redefine-og.webp">
<meta property="article:published_time" content="2025-12-29T12:48:39.000Z">
<meta property="article:modified_time" content="2026-01-18T05:24:38.322Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackc0der.github.io/images/redefine-og.webp">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/%E6%A9%98%E7%8C%AB.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/%E6%A9%98%E7%8C%AB.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/%E6%A9%98%E7%8C%AB.ico">
    <!--- Page Info-->
    
    <title>
        
            Linux Kernel PWN | HackC0der&#39;s Blog
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
        <link href="" rel="stylesheet">
    
    
    
    
        
<script src="/js/build/libs/anime.min.js"></script>

    

    <script id="hexo-configurations">
    window.config = {"hostname":"hackc0der.github.io","root":"/","language":"zh-CN","path":"search.json"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":true,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":true,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":true},"open_graph":{"enable":true,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"What you have done does make who you are...","subtitle":{"text":["明月几时有，把酒问青天","不知天上宫阙，今夕是何年？","我欲乘风归去，又恐琼楼玉宇，高处不胜寒。","起舞弄清影，何似在人间！","转朱阁，低绮户，照无眠。","不应有恨，何事长向别时圆？","人有悲欢离合，月有阴晴圆缺，此事古难全。","但愿人长久，千里共婵娟。","我步入丛林，因为我希望活得有意义…","我希望活得深刻，汲取生命所有的精髓！","把非生命的一切全都击溃…","以免在我生命终结时，发现自己从来没有活过…"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/HackC0der","instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"CSDN":{"path":"https://blog.csdn.net/Mr_Fmnwon?type=blog","icon":"fa-sharp fa-solid fa-browser"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2025/11/27 23:36:22"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <h2 class="ml13">
        HackC0der&#39;s Blog
    </h2>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }
    </script>
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                HackC0der&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   target="_blank" rel="noopener" href="https://blog.csdn.net/Mr_Fmnwon?type=blog"
                                        >
                                    <i class="fa-sharp fa-solid fa-browser fa-fw"></i>
                                    CSDN
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           target="_blank" rel="noopener" href="https://blog.csdn.net/Mr_Fmnwon?type=blog"
                        >
                            <span>
                                CSDN
                            </span>
                            
                                <i class="fa-sharp fa-solid fa-browser fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Linux Kernel PWN</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/redefine-avatar.svg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">HackC0der</span>
					
					<span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv1</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-12-29 20:48:39</span>
        <span class="mobile">2025-12-29 20:48:39</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2026-01-18 13:24:38</span>
            <span class="mobile">2026-01-18 13:24:38</span>
            <span class="hover-info">更新</span>
        </span>
    

    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>16.3k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>70 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h2 id="一、基础知识"><a href="#一、基础知识" class="headerlink" title="一、基础知识"></a>一、基础知识</h2><blockquote>
<p>参考自CTF-WIKI：</p>
<ol>
<li><p><a class="link" target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/basic-knowledge/">基础知识 - CTF Wiki<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
<li><p><a class="link" target="_blank" rel="noopener" href="https://kiprey.github.io/2021/10/kernel_pwn_introduction/#%E4%B8%80%E3%80%81%E7%AE%80%E4%BB%8B">Kernel pwn CTF 入门 | Kiprey’s Blog<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
<li><h6 id><a href="#" class="headerlink" title></a></h6></li>
</ol>
</blockquote>
<ul>
<li><p><strong>操作系统内核</strong></p>
<p>操作系统内核（Operation System Kernel）本质上也是一种软件，可以看作是普通应用程式与硬件之间的一层中间层，其主要作用便是调度系统资源、控制 IO 设备、操作网络与文件系统等，并为上层应用提供便捷、抽象的应用接口。CPU 执行操作系统内核代码时通常运行在高权限，拥有着完全的硬件访问能力，而 CPU 在执行用户态代码时通常运行在低权限环境，只拥有部分 &#x2F; 缺失硬件访问能力。</p>
</li>
<li><p><strong>分级保护域</strong></p>
<p>又被称作保护环，简称 Rings ，是一种将计算机不同的资源划分至不同权限的模型。Intel 的 CPU 将权限分为四个等级：Ring0、Ring1、Ring2、Ring3，权限等级依次降低，现代操作系统模型中我们通常只会使用 ring0 和 ring3，对应操作系统内核与用户进程，即 CPU 在执行用户进程代码时处在 ring3 下。</p>
<ul>
<li>用户态：CPU 运行在 ring3 + 用户进程运行环境上下文。</li>
<li>内核态：CPU 运行在 ring0 + 内核代码运行环境上下文。</li>
</ul>
</li>
</ul>
<h3 id="（一）特权级切换"><a href="#（一）特权级切换" class="headerlink" title="（一）特权级切换"></a>（一）<strong>特权级切换</strong></h3><p>CPU 在不同的特权级间进行切换主要有两个途径：</p>
<ul>
<li>中断与异常（interrupt &amp; exception）：当 CPU 收到一个中断 &#x2F; 异常时，会切换到 ring0，并根据中断描述符表索引对应的中断处理代码以执行。</li>
<li>特权级相关指令：当 CPU 运行这些指令时会发生运行状态的改变，例如 iret 指令（ring0-&gt;ring3）或是 sysenter 指令（ring3-&gt;ring0）。</li>
</ul>
<ul>
<li><p><strong>user space to kernel space （系统调用）</strong></p>
<p>当发生 <code>系统调用</code>，<code>产生异常</code>，<code>外设产生中断</code> 等事件时，会发生用户态到内核态的切换，进入到内核相对应的处理程序中进行处理。</p>
<ol>
<li><p>通过 <code>swapgs</code> 切换 GS 段寄存器，将 GS 寄存器值和一个特定位置的值进行交换，目的是保存 GS 值，同时将该位置的值作为内核执行时的 GS 值使用。</p>
</li>
<li><p>将当前栈顶（用户空间栈顶）记录在 CPU 独占变量区域里，将 CPU 独占区域里记录的内核栈顶放入 rsp&#x2F;esp。</p>
</li>
<li><p>通过 push 保存各寄存器值</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> ENTRY(entry_SYSCALL_64)</span><br><span class="line"> <span class="comment">/* SWAPGS_UNSAFE_STACK是一个宏，x86直接定义为swapgs指令 */</span></span><br><span class="line"> SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 保存栈值，并设置内核栈 */</span></span><br><span class="line"> movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line"> movq <span class="title function_">PER_CPU_VAR</span><span class="params">(cpu_current_top_of_stack)</span>, %rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 通过push保存寄存器值，形成一个pt_regs结构 */</span></span><br><span class="line"><span class="comment">/* Construct struct pt_regs on stack */</span></span><br><span class="line">pushq  $__USER_DS      <span class="comment">/* pt_regs-&gt;ss */</span></span><br><span class="line">pushq  <span class="title function_">PER_CPU_VAR</span><span class="params">(rsp_scratch)</span>  <span class="comment">/* pt_regs-&gt;sp */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;flags */</span></span><br><span class="line">pushq  $__USER_CS      <span class="comment">/* pt_regs-&gt;cs */</span></span><br><span class="line">pushq  %rcx             <span class="comment">/* pt_regs-&gt;ip */</span></span><br><span class="line">pushq  %rax             <span class="comment">/* pt_regs-&gt;orig_ax */</span></span><br><span class="line">pushq  %rdi             <span class="comment">/* pt_regs-&gt;di */</span></span><br><span class="line">pushq  %rsi             <span class="comment">/* pt_regs-&gt;si */</span></span><br><span class="line">pushq  %rdx             <span class="comment">/* pt_regs-&gt;dx */</span></span><br><span class="line">pushq  %rcx tuichu    <span class="comment">/* pt_regs-&gt;cx */</span></span><br><span class="line">pushq  $-ENOSYS        <span class="comment">/* pt_regs-&gt;ax */</span></span><br><span class="line">pushq  %r8              <span class="comment">/* pt_regs-&gt;r8 */</span></span><br><span class="line">pushq  %r9              <span class="comment">/* pt_regs-&gt;r9 */</span></span><br><span class="line">pushq  %r10             <span class="comment">/* pt_regs-&gt;r10 */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;r11 */</span></span><br><span class="line">sub $<span class="params">(<span class="number">6</span>*<span class="number">8</span>)</span>, %rsp      <span class="comment">/* pt_regs-&gt;bp, bx, r12-15 not saved */</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>通过汇编指令判断是否为 <code>x32_abi</code>。</p>
</li>
<li><p>通过系统调用号，跳到全局变量 <code>sys_call_table</code> 相应位置继续执行系统调用。</p>
</li>
</ol>
</li>
<li><p><strong>kernel space to user space</strong></p>
<p>退出时，流程如下：</p>
<ul>
<li>通过 <code>swapgs</code> 恢复 GS 值。</li>
<li>通过 <code>sysretq</code> 或者 <code>iretq</code> 恢复到用户控件继续执行。如果使用 <code>iretq</code> 还需要给出用户空间的一些信息（CS, eflags&#x2F;rflags, esp&#x2F;rsp 等）。</li>
</ul>
</li>
</ul>
<h3 id="（二）虚拟内存空间"><a href="#（二）虚拟内存空间" class="headerlink" title="（二）虚拟内存空间"></a>（二）虚拟内存空间</h3><p>在现代操作系统中，计算机的虚拟内存地址空间通常被分为两块——供用户进程使用的用户空间（user space）与供操作系统内核使用的内核空间（kernel space），对于 Linux 而言，通常位于较高虚拟地址的虚拟内存空间被分配给内核使用，而位于较低虚拟地址的虚拟内存空间责备分配给用户进程使用。</p>
<p>32 位下的虚拟内存空间布局如下：</p>


<p>64 位下的虚拟内存空间布局如下：</p>


<h3 id="（三）进程权限管理"><a href="#（三）进程权限管理" class="headerlink" title="（三）进程权限管理"></a>（三）进程权限管理</h3><p>内核 kernel 调度着一切的系统资源，并为用户应用程式提供运行环境，相应地，应用程式的权限也都是由 kernel 进行管理的。</p>
<ul>
<li><p><strong>进程描述符（process descriptor）</strong></p>
<p>在内核中使用结构体 <code>task_struct</code> 表示一个进程，该结构体定义于内核源码 <code>include/linux/sched.h</code> 中</p>

</li>
<li><p><strong>进程权限凭证（credential）</strong></p>
<p><code>task_struct</code> 的源码中有如下代码：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">cred</span>;</span></span><br></pre></td></tr></table></figure></div>

<p>结构体 <code>cred</code> 用以管理一个进程的权限，该结构体定义于内核源码 <code>include/linux/cred.h</code> 中，如下：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The security context of a task</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The parts of the context break down into two categories:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (1) The objective context of a task.  These parts are used when some other</span></span><br><span class="line"><span class="comment"> *  task is attempting to affect this one.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (2) The subjective context.  These details are used when the task is acting</span></span><br><span class="line"><span class="comment"> *  upon another object, be that a file, a task, a key or whatever.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that some members of this structure belong to both categories - the</span></span><br><span class="line"><span class="comment"> * LSM security pointer for instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A task has two security pointers.  task-&gt;real_cred points to the objective</span></span><br><span class="line"><span class="comment"> * context that defines that task&#x27;s actual details.  The objective part of this</span></span><br><span class="line"><span class="comment"> * context is used whenever that task is acted upon.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * task-&gt;cred points to the subjective context that defines the details of how</span></span><br><span class="line"><span class="comment"> * that task is going to act upon another object.  This may be overridden</span></span><br><span class="line"><span class="comment"> * temporarily to point to another security context, but normally points to the</span></span><br><span class="line"><span class="comment"> * same context as task-&gt;real_cred.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_long_t</span>   usage;</span><br><span class="line">    <span class="type">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="type">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="type">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   jit_keyring;    <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">                     * keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="type">void</span>        *security;  <span class="comment">/* LSM security */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>   <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ucounts</span> *<span class="title">ucounts</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>  <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="comment">/* RCU deletion */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> non_rcu;            <span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure></div>

<p>一个 cred 结构体中记载了一个进程四种不同的用户 ID，在通常情况下这几个 ID 应当都是相同的：</p>
<ul>
<li>真实用户 ID（real UID）：标识一个进程启动时的用户 ID</li>
<li>保存用户 ID（saved UID）：标识一个进程最初的有效用户 ID</li>
<li>有效用户 ID（effective UID）：标识一个进程正在运行时所属的用户 ID，一个进程在运行途中是可以改变自己所属用户的，因而权限机制也是通过有效用户 ID 进行认证的，内核通过 euid 来进行特权判断；为了防止用户一直使用高权限，当任务完成之后，euid 会与 suid 进行交换，恢复进程的有效权限</li>
<li>文件系统用户 ID（UID for VFS ops）：标识一个进程创建文件时进行标识的用户 ID</li>
</ul>
<p>用户组 ID 同样分为四个：真实组 ID、保存组 ID、有效组 ID、文件系统组 ID，与用户 ID 类似</p>
</li>
<li><p><strong>进程权限改变</strong></p>
<p>前面我们讲到，一个进程的权限是由位于内核空间的 <code>cred</code> 结构体进行管理的，那么我们不难想到：只要改变一个进程的 <code>cred</code> 结构体，就能改变其执行权限。</p>
<p>在内核空间有如下两个函数，都位于 <code>kernel/cred.c</code> 中：</p>
<ul>
<li><code>struct cred* prepare_kernel_cred(struct task_struct* daemon)</code>：该函数用以拷贝一个进程的 cred 结构体，并返回一个新的 cred 结构体，需要注意的是 daemon 参数应为有效的进程描述符地址。</li>
<li><code>int commit_creds(struct cred *new)</code>：该函数用以将一个新的 cred 结构体应用到进程。</li>
</ul>
</li>
</ul>
<h3 id="（四）Loadable-Kernel-Modules-LKMs"><a href="#（四）Loadable-Kernel-Modules-LKMs" class="headerlink" title="（四）Loadable Kernel Modules(LKMs)"></a>（四）Loadable Kernel Modules(LKMs)</h3><p><strong>可装载内核模块</strong>（Loadable Kernel Modules，简称 LKMs），位于内核空间的 LKMs 可以提供新的系统调用或其他服务，同时 LKMs 可以像积木一样被装载入内核 &#x2F; 从内核中卸载，大大提高了 kernel 的可拓展性与可维护性。</p>
<p>常见的 LKMs 包括：</p>
<ul>
<li>驱动程序（Device drivers）：设备驱动、文件系统驱动…</li>
<li>内核扩展模块 (modules)</li>
</ul>
<p>LKMs 的文件格式和用户态的可执行程序相同，Linux 下为 ELF，Windows 下为 exe&#x2F;dll，mac 下为 MACH-O，因此我们可以用 IDA 等工具来分析内核模块。</p>
<p>模块可以被单独编译，但不能单独运行。它在运行时被链接到内核作为内核的一部分在内核空间运行，这与运行在用户控件的进程不同。</p>
<p>模块通常用来实现一种文件系统、一个驱动程序或者其他内核上层的功能。</p>
<blockquote>
<p>Linux 内核之所以提供模块机制，是因为它本身是一个单内核 (monolithic kernel)。单内核的优点是效率高，因为所有的内容都集合在一起，但缺点是可扩展性和可维护性相对较差，模块机制就是为了弥补这一缺陷。</p>
</blockquote>
<ul>
<li>相关指令<ul>
<li><strong>insmod</strong>: 讲指定模块加载到内核中</li>
<li><strong>rmmod</strong>: 从内核中卸载指定模块</li>
<li><strong>lsmod</strong>: 列出已经加载的模块</li>
<li><strong>modprobe</strong>: 添加或删除模块，modprobe 在加载模块时会查找依赖关系</li>
</ul>
</li>
</ul>
<blockquote>
<p>大多数CTF中的 kernel vulnerability 也出现在 LKM 中。</p>
</blockquote>
<h3 id="（五）内核交互"><a href="#（五）内核交互" class="headerlink" title="（五）内核交互"></a>（五）内核交互</h3><p>系统调用，指的是用户空间的程序向操作系统内核请求需要更高权限的服务，比如 IO 操作或者进程间通信。系统调用提供用户程序与操作系统间的接口，部分库函数（如 scanf，puts 等 IO 相关的函数实际上是对系统调用的封装（read 和 write））。</p>
<blockquote>
<p>在 <em>&#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu&#x2F;asm&#x2F;unistd_64.h</em> 和 <em>&#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu&#x2F;asm&#x2F;unistd_32.h</em> 分别可以查看 64 位和 32 位的系统调用号。</p>
<p> <a class="link" target="_blank" rel="noopener" href="https://syscalls.kernelgrok.com/">Linux Syscall Reference<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>可以查阅 32 位系统调用对应的寄存器含义以及源码。</p>
<p> <a class="link" target="_blank" rel="noopener" href="https://syscalls64.paolostivanin.com/">Linux Syscall64 Reference<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>可以查阅 64 位系统调用对应的寄存器含义以及源码</p>
</blockquote>
<ul>
<li><p><strong>系统调用：ioctl</strong></p>
<p>在 <code>*NIX</code> 中一切都可以被视为文件，因而一切都可以以访问文件的方式进行操作，为了方便，Linux 定义了系统调用 <code>ioctl</code> 供进程与设备之间进行通信。</p>
<p><code>ioctl</code> 是一个专用于设备输入输出操作的一个系统调用，其调用方式如下：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ioctl</span><span class="params">(<span class="type">int</span> fd, <span class="type">unsigned</span> <span class="type">long</span> request, ...)</span></span><br></pre></td></tr></table></figure></div>

<p>其第一个参数为打开设备 (open) 返回的 <a class="link" target="_blank" rel="noopener" href="http://m4x.fun/post/play-with-file-descriptor-1/">文件描述符<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，第二个参数为用户程序对设备的控制命令，再后边的参数则是一些补充参数，与设备有关。</p>
<p>对于一个提供了 ioctl 通信方式的设备而言，我们可以通过其文件描述符、使用不同的请求码及其他请求参数通过 ioctl 系统调用完成不同的对设备的 I&#x2F;O 操作。</p>
<blockquote>
<p>使用 ioctl 进行通信的原因：</p>
<p>操作系统提供了内核访问标准外部设备的系统调用，因为大多数硬件设备只能够在内核空间内直接寻址, 但是当访问非标准硬件设备这些系统调用显得不合适, 有时候用户模式可能需要直接访问设备。</p>
<p>比如，一个系统管理员可能要修改网卡的配置。现代操作系统提供了各种各样设备的支持，有一些设备可能没有被内核设计者考虑到，如此一来提供一个这样的系统调用来使用设备就变得不可能了。</p>
<p>为了解决这个问题，内核被设计成可扩展的，可以加入一个称为设备驱动的模块，驱动的代码允许在内核空间运行而且可以对设备直接寻址。一个 Ioctl 接口是一个独立的系统调用，通过它用户空间可以跟设备驱动沟通。对设备驱动的请求是一个以设备和请求号码为参数的 Ioctl 调用，如此内核就允许用户空间访问设备驱动进而访问设备而不需要了解具体的设备细节，同时也不需要一大堆针对不同设备的系统调用。</p>
</blockquote>
</li>
</ul>
<h3 id="（六）内核态常见函数"><a href="#（六）内核态常见函数" class="headerlink" title="（六）内核态常见函数"></a>（六）内核态常见函数</h3><p>在内核当中我们无法使用用户态的 C 库中的函数，内核自己有着对应的各种函数，其中常用的功能函数如下：</p>
<ul>
<li>printf() -&gt; **printk()**，但需要注意的是 printk() 不一定会把内容显示到终端上，但一定在内核缓冲区里，可以通过 <code>dmesg</code> 查看效果</li>
<li>memcpy() -&gt;copy_from_user()&#x2F;copy_to_user()<ul>
<li>copy_from_user() 实现了将用户空间的数据传送到内核空间</li>
<li>copy_to_user() 实现了将内核空间的数据传送到用户空间</li>
</ul>
</li>
<li>malloc() -&gt; **kmalloc()**，内核态的内存分配函数，和 malloc() 相似，但使用的是 <code>slab/slub 分配器</code></li>
<li>free() -&gt; **kfree()**，同 kmalloc()</li>
</ul>
<p>此外，<code>kernel 管理进程，因此 kernel 也记录了进程的权限</code>。kernel 中有两个可以方便的改变权限的函数：</p>
<ul>
<li><strong>int commit_creds(struct cred *new)</strong></li>
<li><strong>struct cred* prepare_kernel_cred(struct task_struct* daemon)</strong></li>
</ul>
<p>从函数名也可以看出，执行 <code>commit_creds(prepare_kernel_cred(&amp;init_task))</code> 即可获得 root 权限，即拷贝 init 进程的 cred 作为当前进程的新的 credentials。</p>
<blockquote>
<p>更多关于 <code>prepare_kernel_cred</code> 的信息可以参考 <a class="link" target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.6/source/kernel/cred.c#L594">源码<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p>执行 <code>commit_creds(prepare_kernel_cred(&amp;init_task))</code> 也是最常用的提权手段，这些函数与变量的地址都可以在 <code>/proc/kallsyms</code> 中查看（较老的内核版本中是 <code>/proc/ksyms</code>），该文件的内容通常需要 root 权限才能正确查看。</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cat</span> /proc/kallsyms | grep <span class="string">&quot;T commit_creds&quot;</span></span><br><span class="line">ffffffffbb11ab20 T commit_creds</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cat</span> /proc/kallsyms | grep <span class="string">&quot;T prepare_kernel_cred&quot;</span></span><br><span class="line">ffffffffbb11b080 T prepare_kernel_cred</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cat</span> /proc/kallsyms | grep <span class="string">&quot;D init_cred&quot;</span></span><br><span class="line">ffffffffbce58840 D init_cred</span><br></pre></td></tr></table></figure></div>

<h3 id="（七）缓解措施"><a href="#（七）缓解措施" class="headerlink" title="（七）缓解措施"></a>（七）缓解措施</h3><p>与一般的程序相同，Linux Kernel 同样有着各种各样的保护机制。</p>
<ul>
<li><p><strong>KASLR</strong></p>
<p>KASLR 即<code>内核空间地址随机化</code>（kernel address space layout randomize），与用户态程序的 ASLR 相类似——在内核镜像映射到实际的地址空间时加上一个偏移值（粒度为 256MB），但是内核内部的相对偏移其实还是不变的。</p>
<p>在未开启 KASLR 保护机制时，内核代码段的基址为 <code>0xffffffff81000000</code> ，direct mapping area 的基址为 <code>0xffff888000000000</code>。</p>
<p>内核内存布局可以参考<a class="link" target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.3/source/Documentation/x86/x86_64/mm.rst">这里<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
</li>
<li><p><strong>*FGKASLR</strong></p>
<p>KASLR 虽然在一定程度上能够缓解攻击，但是若是攻击者通过一些信息泄露漏洞获取到内核中的某个地址，仍能够直接得知内核加载地址偏移从而得知整个内核地址布局，因此有研究者基于 KASLR 实现了 FGKASLR，<strong>以函数粒度重新排布内核代码</strong>。</p>
</li>
<li><p><strong>STACK PROTECTOR</strong></p>
<p>类似于用户态程序的 canary，通常又被称作是 stack cookie，用以检测<strong>是否发生内核堆栈溢出</strong>，若是发生内核堆栈溢出则会产生 kernel panic。内核中的 canary 的值通常取自 gs 段寄存器某个固定偏移处的值。</p>
</li>
<li><p><strong>SMAP&#x2F;SMEP</strong></p>
<p>SMAP 即<code>管理模式访问保护</code>（Supervisor Mode Access Prevention），SMEP 即<code>管理模式执行保护</code>（Supervisor Mode Execution Prevention），这两种保护通常是同时开启的，用以阻止<strong>内核空间直接访问 &#x2F; 执行用户空间的数据</strong>，完全地将内核空间与用户空间相分隔开，用以防范 ret2usr（return-to-user，将内核空间的指令指针重定向至用户空间上构造好的提权代码）攻击。</p>
<p>SMEP 保护的绕过有以下两种方式：</p>
<ul>
<li>利用内核线性映射区对物理地址空间的完整映射，找到用户空间对应页框的内核空间地址，利用该内核地址完成对用户空间的访问（即一个内核空间地址与一个用户空间地址映射到了同一个页框上），这种攻击手法称为 ret2dir 。</li>
<li>Intel 下系统根据 CR4 控制寄存器的第 20 位标识是否开启 SMEP 保护（1 为开启，0 为关闭），若是能够通过 kernel ROP 改变 CR4 寄存器的值便能够关闭 SMEP 保护，完成 SMEP-bypass，接下来就能够重新进行 ret2usr，<strong>但对于开启了 KPTI 的内核而言，内核页表的用户地址空间无执行权限，这使得 ret2usr 彻底成为过去式</strong> 。</li>
</ul>
</li>
<li><p><strong>KPTI</strong></p>
<p>KPTI 即 <code>内核页表隔离</code>（Kernel page-table isolation），内核空间与用户空间分别使用两组不同的页表集，这对于内核的内存管理产生了根本性的变化。</p>
<p>需要进行说明的是，<strong>在这两张页表上都有着对用户内存空间的完整映射，但在用户页表中只映射了少量的内核代码（例如系统调用入口点、中断处理等），而只有在内核页表中才有着对内核内存空间的完整映射，但两张页表都有着对用户内存空间的完整映射</strong>，如下图所示，左侧是未开启 KPTI 后的页表布局，右侧是开启了 KPTI 后的页表布局。</p>


<p>KPTI 的发明主要是用来修复一个史诗级别的 CPU 硬件漏洞：Meltdown。简单理解就是利用 CPU 流水线设计中（乱序执行与预测执行）的漏洞来获取到用户态无法访问的内核空间的数据，属于侧信道攻击的一种。</p>
<p><strong>KPTI 同时还令内核页表中属于用户地址空间的部分不再拥有执行权限，这使得 ret2usr 彻底成为过去式</strong>。</p>
</li>
<li><p><strong>Hardened Usercopy</strong></p>
<p>hardened usercopy 是用以在用户空间与内核空间之间拷贝数据时进行越界检查的一种防护机制，<strong>主要检查拷贝过程中对内核空间中数据的读写是否会越界</strong>：</p>
<ul>
<li>读取的数据长度是否超出源 object 范围。</li>
<li>写入的数据长度是否超出目的 object 范围。</li>
</ul>
<p>这一保护被用于 <code>copy_to_user()</code> 与 <code>copy_from_user()</code> 等数据交换 API 中，不过这种保护 <em>不适用于内核空间内的数据拷贝</em> ，这也是目前主流的绕过手段。</p>
</li>
<li><p><strong>Hardened freelist</strong></p>
<p>类似于 glibc 2.32 版本引入的保护，在开启这种保护之前，slub 中的 free object 的 next 指针直接存放着 next free object 的地址，攻击者可以通过读取 freelist 泄露出内核线性映射区的地址，在开启了该保护之后 free object 的 next 指针存放的是由以下三个值进行异或操作后的值：</p>
<ul>
<li>当前 free object 的地址。</li>
<li>下一个 free object 的地址。</li>
<li>由 kmem_cache 指定的一个 random 值。</li>
</ul>
<p>攻击者至少需要获取到第一与第三个值才能篡改 freelist，这无疑为对 freelist 的直接利用增添不少难度。</p>
</li>
<li><p><strong>Random freelist</strong></p>
<p>这种保护主要发生在 slub allocator 向 buddy system 申请到页框之后的处理过程中，对于未开启这种保护的一张完整的 slub，其上的 object 的连接顺序是线性连续的，但在开启了这种保护之后其上的 object 之间的连接顺序是随机的，这让攻击者无法直接预测下一个分配的 object 的地址。</p>
<p>需要注意的是这种保护发生在 <strong>slub allocator 刚从 buddy system 拿到新 slub 的时候，运行时 freelist 的构成仍遵循 LIFO</strong>。</p>

</li>
<li><p><strong>CONFIG_INIT_ON_ALLOC_DEFAULT_ON</strong></p>
<p>当编译内核时开启了这个选项时，在内核进行 “堆内存” 分配时（包括 buddy system 和 slab allocator），<strong>会将被分配的内存上的内容进行清零</strong>，从而防止了利用未初始化内存进行数据泄露的情况。</p>
</li>
</ul>
<h2 id="二、Kernel-PWN-题型"><a href="#二、Kernel-PWN-题型" class="headerlink" title="二、Kernel PWN 题型"></a>二、Kernel PWN 题型</h2><h3 id="（一）常规题目文件"><a href="#（一）常规题目文件" class="headerlink" title="（一）常规题目文件"></a>（一）常规题目文件</h3><p>传统的 kernel pwn 题目通常会给以下三个文件：</p>
<ol>
<li>boot.sh: 一个用于启动 kernel 的 shell 的脚本，多用 qemu，保护措施与 qemu 不同的启动参数有关</li>
<li>bzImage: compressed kernel binary</li>
<li>rootfs.cpio: 文件系统映像</li>
</ol>
<p>以 CISCN2017 - babydriver 为例：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">CISCN2017_babydriver [master●] <span class="built_in">ls</span></span><br><span class="line">babydriver.tar</span><br><span class="line">CISCN2017_babydriver [master●] x babydriver.tar</span><br><span class="line">boot.sh</span><br><span class="line">bzImage</span><br><span class="line">rootfs.cpio</span><br><span class="line">CISCN2017_babydriver [master●] <span class="built_in">ls</span></span><br><span class="line">babydriver.tar  boot.sh  bzImage  rootfs.cpio</span><br><span class="line">CISCN2017_babydriver [master●] file bzImage</span><br><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 (atum@ubuntu) <span class="comment">#1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0x6, Normal VGA</span></span><br><span class="line">CISCN2017_babydriver [master●] file rootfs.cpio</span><br><span class="line">rootfs.cpio: gzip compressed data, last modified: Tue Jul  4 08:39:15 2017, max compression, from Unix, original size 2844672</span><br><span class="line">CISCN2017_babydriver [master●] file boot.sh</span><br><span class="line">boot.sh: Bourne-Again shell script, ASCII text executable</span><br><span class="line">CISCN2017_babydriver [master●] bat boot.sh </span><br><span class="line">───────┬─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">       │ File: boot.sh</span><br><span class="line">───────┼─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   1   │ <span class="comment">#!/bin/bash</span></span><br><span class="line">   2   │ </span><br><span class="line">   3   │ qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="string">&#x27;console=ttyS0 ro</span></span><br><span class="line"><span class="string">       │ ot=/dev/ram oops=panic panic=1&#x27;</span> -enable-kvm -monitor /dev/null -m 64M --nographi</span><br><span class="line">       │ c  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br><span class="line">───────┴─────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure></div>

<p>其中主要的 qemu 参数含义如下：</p>
<ul>
<li>-initrd rootfs.cpio，使用 rootfs.cpio 作为内核启动的文件系统</li>
<li>-kernel bzImage，使用 bzImage 作为 kernel 映像</li>
<li>-cpu kvm64,+smep，设置 CPU 的安全选项，这里开启了 smep</li>
<li>-m 64M，设置虚拟 RAM 为 64M，默认为 128M</li>
</ul>
<p>其他的 qemu 参数可以通过 –help 查看。</p>
<h3 id="（二）远程上传"><a href="#（二）远程上传" class="headerlink" title="（二）远程上传"></a>（二）远程上传</h3><p>通常情况下我们需要将在本地编写好的 exploit 程序进行静态编译并传输到远程，比较通用的办法便是将 exploit 进行 base64 编码后传输，可参考如下脚本：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./exp&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    exp = base64.b64encode(f.read())</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">11451</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./run.sh&#x27;)</span></span><br><span class="line">p.sendline()</span><br><span class="line">p.recvuntil(<span class="string">&quot;/ $&quot;</span>)</span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(exp), <span class="number">0x200</span>):</span><br><span class="line">    p.sendline(<span class="string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="number">0x200</span>].decode() + <span class="string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    log.info(<span class="string">&quot;count: &quot;</span> + <span class="built_in">str</span>(count))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;/ $&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;chmod +x /tmp/exploit&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;/tmp/exploit &quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



<h2 id="三、环境搭建"><a href="#三、环境搭建" class="headerlink" title="三、环境搭建"></a>三、环境搭建</h2><h3 id="（一）内核源码"><a href="#（一）内核源码" class="headerlink" title="（一）内核源码"></a>（一）内核源码</h3><p>下载内核源码，尔后编译生成内核镜像文件（bzImage）</p>
<ol>
<li><a class="link" target="_blank" rel="noopener" href="https://www.kernel.org/">https://www.kernel.org/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/kernel/">https://mirrors.tuna.tsinghua.edu.cn/kernel/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ol>
<blockquote>
<p>内核主要有以下几种类别：</p>
<ul>
<li>Prepatch (RC) ：主线内核的预发布版本，包含了最新的待测试的内核特性，由 Linus Torvalds 维护。</li>
<li>Mainline：主线内核版本，RC 版本的新特性经过测试后便会合并到主线，每 9～10 周发一个版本，由 Linus Torvalds 维护。</li>
<li>Stable：主线内核发布后便会变为 Stable 状态，其仅会被 stable kernel 维护者从主线树后向移植一些漏洞修复，直到下个内核版本释出。Stable kernel 根据需要进行更新，通常是一周一次。</li>
<li>Longterm：部分内核版本会被选作长期支持版（LTS），相比起 Stable 内核有着更久的支持时长，通常仅会被后向移植重要的漏洞修复，且更新周期较慢（尤其是对于更老的版本）。</li>
</ul>
</blockquote>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">╭─ ~/kernels/linux-6.18 ▓▒░───────────────────────────────────────────────░▒▓ ✔  base Py  at 00:20:55</span><br><span class="line">╰─ wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.18.tar.xz</span><br><span class="line">--2026-01-02 00:21:00--  https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.18.tar.xz</span><br><span class="line">Resolving mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)... 101.6.15.130, 2402:f000:1:400::2</span><br><span class="line">Connecting to mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)|101.6.15.130|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 154309096 (147M) [application/octet-stream]</span><br><span class="line">Saving to: ‘linux-6.18.tar.xz’</span><br><span class="line"></span><br><span class="line">linux-6.18.tar.xz          100%[=====================================&gt;] 147.16M  5.62MB/s    <span class="keyword">in</span> 24s</span><br><span class="line"></span><br><span class="line">2026-01-02 00:21:24 (6.04 MB/s) - ‘linux-6.18.tar.xz’ saved [154309096/154309096]</span><br></pre></td></tr></table></figure></div>

<h3 id="（二）内核签名验证"><a href="#（二）内核签名验证" class="headerlink" title="（二）内核签名验证"></a>（二）内核签名验证</h3><p>导入 Linus Torvalds 和 Greg Kroah-Hartman 的公钥：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">╭─ ~/kernels/linux-6.18 ▓▒░────────────────────────────────────░▒▓ ✔  took 12s  base Py  at 00:24:49</span><br><span class="line">╰─ gpg2 --locate-keys torvalds@kernel.org gregkh@kernel.org</span><br><span class="line">gpg: directory <span class="string">&#x27;/home/user/.gnupg&#x27;</span> created</span><br><span class="line">gpg: keybox <span class="string">&#x27;/home/user/.gnupg/pubring.kbx&#x27;</span> created</span><br><span class="line">gpg: /home/user/.gnupg/trustdb.gpg: trustdb created</span><br><span class="line">gpg: key 38DBBDC86092693E: public key <span class="string">&quot;Greg Kroah-Hartman &lt;gregkh@kernel.org&gt;&quot;</span> imported</span><br><span class="line">gpg: Total number processed: 1</span><br><span class="line">gpg:               imported: 1</span><br><span class="line">gpg: key 79BE3E4300411886: public key <span class="string">&quot;Linus Torvalds &lt;torvalds@kernel.org&gt;&quot;</span> imported</span><br><span class="line">gpg: Total number processed: 1</span><br><span class="line">gpg:               imported: 1</span><br><span class="line">pub   rsa4096 2011-09-23 [SC]</span><br><span class="line">      647F28654894E3BD457199BE38DBBDC86092693E</span><br><span class="line">uid           [ unknown] Greg Kroah-Hartman &lt;gregkh@kernel.org&gt;</span><br><span class="line">sub   rsa4096 2011-09-23 [E]</span><br><span class="line"></span><br><span class="line">pub   rsa2048 2011-09-20 [SC]</span><br><span class="line">      ABAF11C65A2970B130ABE3C479BE3E4300411886</span><br><span class="line">uid           [ unknown] Linus Torvalds &lt;torvalds@kernel.org&gt;</span><br><span class="line">sub   rsa2048 2011-09-20 [E]</span><br></pre></td></tr></table></figure></div>

<p>下载内核签名进行校验：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">╭─ ~/kernels/linux-6.18 ▓▒░─────────────────────────────────────░▒▓ ✔  took 4s  base Py  at 00:26:05</span><br><span class="line">╰─ wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.18.tar.sign</span><br><span class="line">--2026-01-02 00:26:40--  https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.18.tar.sign</span><br><span class="line">Resolving mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)... 101.6.15.130, 2402:f000:1:400::2</span><br><span class="line">Connecting to mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)|101.6.15.130|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 985 [application/octet-stream]</span><br><span class="line">Saving to: ‘linux-6.18.tar.sign’</span><br><span class="line"></span><br><span class="line">linux-6.18.tar.sign.1      100%[=====================================&gt;]     985  --.-KB/s    <span class="keyword">in</span> 0s</span><br><span class="line"></span><br><span class="line">2026-01-02 00:28:41 (744 MB/s) - ‘linux-6.18.tar.sign.1’ saved [985/985]</span><br><span class="line"></span><br><span class="line">╭─ ~/kernels/linux-6.18 ▓▒░─────────────────────────────────────────────░▒▓ 2 ✘  base Py  at 00:27:34</span><br><span class="line">╰─ unxz ./linux-6.18.tar.xz</span><br><span class="line"></span><br><span class="line">╭─ ~/kernels/linux-6.18 ▓▒░─────────────────────────────────────░▒▓ ✔  took 5s  base Py  at 00:27:55</span><br><span class="line">╰─ <span class="built_in">ls</span></span><br><span class="line">linux-6.18  linux-6.18.tar  linux-6.18.tar.sign</span><br><span class="line"></span><br><span class="line">╭─ ~/kernels/linux-6.18 ▓▒░───────────────────────────────────────────────░▒▓ ✔  base Py  at 00:27:57</span><br><span class="line">╰─ gpg2 --verify linux-6.18.tar.sign</span><br><span class="line">gpg: assuming signed data <span class="keyword">in</span> <span class="string">&#x27;linux-6.18.tar&#x27;</span></span><br><span class="line">gpg: Signature made Mon Dec  1 13:33:58 2025 CST</span><br><span class="line">gpg:                using RSA key 647F28654894E3BD457199BE38DBBDC86092693E</span><br><span class="line">gpg: Good signature from <span class="string">&quot;Greg Kroah-Hartman &lt;gregkh@kernel.org&gt;&quot;</span> [unknown]</span><br><span class="line">gpg: WARNING: This key is not certified with a trusted signature!</span><br><span class="line">gpg:          There is no indication that the signature belongs to the owner.</span><br><span class="line">Primary key fingerprint: 647F 2865 4894 E3BD 4571  99BE 38DB BDC8 6092 693E</span><br><span class="line"></span><br><span class="line">╭─ ~/kernels/linux-6.18 ▓▒░─────────────────────────────────────────────░▒▓ 1 ✘  base Py  at 00:33:48</span><br><span class="line">╰─ gpg2 --tofu-policy good 6092693E</span><br><span class="line">gpg: Setting TOFU trust policy <span class="keyword">for</span> new binding &lt;key: 647F28654894E3BD457199BE38DBBDC86092693E, user <span class="built_in">id</span>: Greg Kroah-Hartman &lt;gregkh@kernel.org&gt;&gt; to good.</span><br></pre></td></tr></table></figure></div>

<h3 id="（三）编译选项"><a href="#（三）编译选项" class="headerlink" title="（三）编译选项"></a>（三）编译选项</h3><p><strong>图形化配置</strong></p>
<p>在内核源码目录下使用如下命令进入图形化的内核配置面板，这也是最常用的内核配置方法 ，其会读取 <code>.config</code> 文件的配置并允许我们在图形化的界面中进行修改，并在该文件不存在时则是会调用 <code>make defconfig</code> 先生成一份默认配置：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure></div>

<p><strong>默认配置</strong></p>
<p><code>make defconfig</code> 生成一份默认的内核配置，其会读取 <code>arch/架构/configs</code> 目录下的配置文件作为基础配置，其包括一份默认启用的内核功能以及驱动编译配置等，这通常会编译上绝大部分常见的驱动，并根据当前系统环境进行相应的微调</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make defconfig</span><br><span class="line"></span><br><span class="line">╭─ ~/kernels/linux-6.18/linux-6.18 ▓▒░─────────────────────░▒▓ INT ✘  took 13s  base Py  at 00:51:51</span><br><span class="line">╰─ make defconfig</span><br><span class="line">*** Default configuration is based on <span class="string">&#x27;x86_64_defconfig&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># configuration written to .config</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

<p><strong>手动配置</strong></p>
<p>逐条询问每一条内核配置是否开启，用户需要在命令行逐条回复 <code>y</code> （编译进内核）、<code>m</code> （作为内核模块编译，部分配置会提供该选项） 、<code>n</code>（不编译）</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make config</span><br></pre></td></tr></table></figure></div>

<p><strong>检测并仅编译内核模块</strong></p>
<p>动态检测当前环境所包含的内核模块（lsmod 命令所显示的内核模块），并在内核编译过程中<strong>仅</strong>编译这些模块，这通常适合嵌入式开发等需要定制化精简与裁剪内核的场景， <em>但往往不适合通用场景</em> ：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任选一条</span></span><br><span class="line">make localyesconfig <span class="comment"># 将驱动编译到内核当中</span></span><br><span class="line">make localmodconfig <span class="comment"># 让驱动以独立内核模块的形式存在</span></span><br></pre></td></tr></table></figure></div>

<p><strong>尽可能全满启用</strong></p>
<p>如下命令（任选一条）会尽可能多地启用可用的内核选项，在生成的配置中包含了尽可能多的内核特性与驱动：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make allyesconfig <span class="comment"># 将驱动编译到内核当中，基于实际使用情况智能配置</span></span><br><span class="line">make allmodconfig <span class="comment"># 让驱动以独立内核模块的形式存在，无脑启用所有功能，适合测试而非实际使用</span></span><br></pre></td></tr></table></figure></div>

<p><strong>调试相关选项</strong></p>
<ul>
<li>Kernel hacking —&gt; Kernel debugging</li>
<li>Kernel hacking —&gt; Compile-time checks and compiler options —&gt; Compile the kernel with debug info</li>
<li>Kernel hacking —&gt; Generic Kernel Debugging Instruments –&gt; KGDB: kernel debugger</li>
<li>kernel hacking —&gt; Compile the kernel with frame pointers</li>
</ul>
<h3 id="（四）编译内核"><a href="#（四）编译内核" class="headerlink" title="（四）编译内核"></a>（四）编译内核</h3><p>我们通常要获得的是压缩后的内核镜像文件 <code>bzImage</code> ，因此我们在源码目录下使用如下命令进行编译：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make bzImage</span><br><span class="line">make -j(<span class="built_in">nproc</span>) bzImage</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>此外，可以:<br>通过 <code>CC=</code> 来指定所使用的编译器，<br>通过 <code>LD=</code> 来指定所使用的链接器，<br>通过 <code>LLVM=</code> 来指定所使用的 LLVM 工具链所在目录。</p>
</blockquote>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  ......</span><br><span class="line">  OBJCOPY <span class="built_in">arch</span>/x86/boot/vmlinux.bin</span><br><span class="line">  AS      <span class="built_in">arch</span>/x86/boot/header.o</span><br><span class="line">  LD      <span class="built_in">arch</span>/x86/boot/setup.elf</span><br><span class="line">  OBJCOPY <span class="built_in">arch</span>/x86/boot/setup.bin</span><br><span class="line">  BUILD   <span class="built_in">arch</span>/x86/boot/bzImage</span><br><span class="line">Kernel: <span class="built_in">arch</span>/x86/boot/bzImage is ready  (#1)</span><br><span class="line"></span><br><span class="line">╭─ ~/kernels/linux-6.18/linux-6.18 ▓▒░───────────────────────░▒▓ ✔  took 5m 6s  base Py  at 01:28:20</span><br><span class="line">╰─ <span class="built_in">ls</span></span><br><span class="line">COPYING        MAINTAINERS  built-in.a  init      modules.builtin          security  vmlinux.a</span><br><span class="line">CREDITS        Makefile     certs       io_uring  modules.builtin.modinfo  sound     vmlinux.o</span><br><span class="line">Documentation  README       crypto      ipc       net                      tools     vmlinux.symvers</span><br><span class="line">Kbuild         System.map   drivers     kernel    rust                     usr       vmlinux.unstripped</span><br><span class="line">Kconfig        <span class="built_in">arch</span>         fs          lib       samples                  virt</span><br><span class="line">LICENSES       block        include     mm        scripts                  vmlinux</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>我们主要关注于编译产物中的两个文件：</p>
<ul>
<li><code>vmlinux</code>：编译生成的 ELF 格式的原始内核镜像文件，通常位于源码根目录下。</li>
<li><code>bzImage</code>：前者进行压缩后的内核镜像文件，通常位于 <code>arch/架构/boot/bzImage</code> （注意对于 x86-64 而言仍是 <code>x86</code> 目录）。</li>
</ul>
<p>常见内核文件格式的介绍：</p>
<ul>
<li><strong>bzImage</strong>：目前主流的 kernel 镜像格式，即 big zImage（即 bz 不是指 bzip2），适用于较大的（大于 512 KB） Kernel。这个镜像会被加载到内存的高地址，高于 1MB。bzImage 是用 gzip 压缩的，文件的开头部分有 gzip 解压缩的代码，所以我们不能用 gunzip 来解压缩。</li>
<li><strong>zImage</strong>：比较老的 kernel 镜像格式，适用于较小的（不大于 512KB） Kernel。启动时，这个镜像会被加载到内存的低地址，即内存的前 640 KB。zImage 也不能用 gunzip 来解压缩。</li>
<li><strong>vmlinuz</strong>：vmlinuz 不仅包含了压缩后的 vmlinux，还包含了 gzip 解压缩的代码。实际上就是 zImage 或者 bzImage 文件。该文件是 bootable 的。 bootable 是指它能够把内核加载到内存中。对于 Linux 系统而言，该文件位于 &#x2F;boot 目录下。该目录包含了启动系统时所需要的文件。</li>
<li><strong>vmlinux</strong>：静态链接的 Linux kernel，以可执行文件的形式存在，尚未经过压缩。该文件往往是在生成 vmlinuz 的过程中产生的。该文件适合于调试。但是该文件不是 bootable 的。</li>
<li><strong>vmlinux.bin</strong>：也是静态链接的 Linux kernel，只是以一个可启动的 (bootable) 二进制文件存在。所有的符号信息和重定位信息都被删除了。生成命令为：<code>objcopy -O binary vmlinux vmlinux.bin</code>。</li>
<li><strong>uImage</strong>：uImage 是 U-boot 专用的镜像文件，它是在 zImage 之前加上了一个长度为 0x40 的 tag 而构成的。这个 tag 说明了这个镜像文件的类型、加载位置、生成时间、大小等信息。</li>
</ul>
<h3 id="（五）下载内核"><a href="#（五）下载内核" class="headerlink" title="（五）下载内核"></a>（五）下载内核</h3><p>可以自己下载发行版仓库中已有的内核镜像，而不需要自行编译一整套Linux内核，Ubuntu为例：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt search linux-image- </span><br><span class="line"><span class="built_in">sudo</span> apt download linux-image-5.8.0-43-generic</span><br><span class="line">dpkg -X ./linux-image-5.8.0-43-generic_5.8.0-43.49~20.04.1_amd64.deb extract</span><br><span class="line">./</span><br><span class="line">./boot/</span><br><span class="line">./boot/vmlinuz-5.8.0-43-generic</span><br><span class="line">./usr/</span><br><span class="line">./usr/share/</span><br><span class="line">./usr/share/doc/</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/changelog.Debian.gz</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/copyright</span><br></pre></td></tr></table></figure></div>

<p>其中的 <code>./boot/vmlinuz-5.8.0-43-generic</code> 便是<code>bzImage</code>内核镜像文件</p>
<h2 id="四、文件系统构建（BusyBox）"><a href="#四、文件系统构建（BusyBox）" class="headerlink" title="四、文件系统构建（BusyBox）"></a>四、文件系统构建（BusyBox）</h2><p>BusyBox 是一个集成了三百多个最常用 Linux 命令和工具的软件，包含了例如 ls 、cat 和 echo 等常见的命令，相比起各大发行版中常用的 GNU core utilities ，BusyBox 更加的轻量化，且更容易进行配置，因此我们将用 busybox 为我们的内核提供一个基本的用户环境。</p>
<h3 id="（一）下载编译BusyBox"><a href="#（一）下载编译BusyBox" class="headerlink" title="（一）下载编译BusyBox"></a>（一）下载编译BusyBox</h3><blockquote>
<p><a class="link" target="_blank" rel="noopener" href="https://busybox.net/downloads/">https://busybox.net/downloads/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p>下载、解压、配置编译选项</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://busybox.net/downloads/busybox-1.36.0.tar.bz2</span><br><span class="line">tar -jxvf busybox-1.36.0.tar.bz2</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure></div>

<p>勾选 <code>Settings</code> —&gt; <code>Build static binary file (no shared lib)</code>以构建不依赖于 libc 的静态编译版本，因为我们的简易内核环境中只有 BusyBox，没有额外的 libc 等运行支持。</p>
<blockquote>
<p>可选项：在 Linux System Utilities 中取消选中 Support mounting NFS file systems on Linux &lt;2.6.23 (NEW)；在 Networking Utilities 中取消选中 inetd。</p>
</blockquote>
<p>编译</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></div>

<p>如果遇到<code>error: ‘TCF_CBQ_LSS_BOUNDED’ undeclared</code>的错误，只需要将<code>networking/tc.c</code>删除即可通过bian’yi</p>
<blockquote>
<p><a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/2202_75820736/article/details/142054146">BusyBox编译时出错_busybox tc.c-CSDN博客<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p>编译完成后会生成一个 <code>_install</code> 目录，接下来我们将会用它来构建我们的文件系统</p>
<h3 id="（二）配置文件系统"><a href="#（二）配置文件系统" class="headerlink" title="（二）配置文件系统"></a>（二）配置文件系统</h3><p><strong>初始化文件系统：</strong> <code>_install</code> 目录下创建基本的文件系统结构：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> _install</span><br><span class="line"><span class="built_in">mkdir</span> -pv &#123;bin,sbin,etc,proc,sys,dev,home/ctf,root,tmp,lib64,lib/x86_64-linux-gnu,usr/&#123;bin,sbin&#125;&#125;</span><br><span class="line"><span class="built_in">touch</span> etc/inittab</span><br><span class="line"><span class="built_in">mkdir</span> etc/init.d</span><br><span class="line"><span class="built_in">touch</span> etc/init.d/rcS</span><br></pre></td></tr></table></figure></div>

<p><strong>配置初始化脚本：</strong> <code>./etc/inittab</code> 中写入如下内容：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure></div>

<p>在上面的文件中指定了系统初始化脚本为 <code>etc/init.d/rcS</code>，因此接下来我们配置这个文件写入如下内容，主要是挂载各种文件系统，以及设置各目录的权限，并创建一个非特权用户：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">chown</span> -R root:root /</span><br><span class="line"><span class="built_in">chmod</span> 700 /root</span><br><span class="line"><span class="built_in">chown</span> -R ctf:ctf /home/ctf</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /home/ctf</span><br><span class="line">su ctf -c sh</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure></div>

<p>为这个脚本添加可执行权限，该脚本通常用作我们自定义的环境初始化脚本：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x ./etc/init.d/rcS</span><br></pre></td></tr></table></figure></div>

<p>接下来我们配置用户组相关权限，在这里建立了两个用户组 <code>root</code> 和 <code>ctf</code> ，以及两个用户 <code>root</code> 和 <code>ctf</code>，并配置了一条文件系统挂载项：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;root:x:0:0:root:/root:/bin/sh&quot;</span> &gt; etc/passwd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ctf:x:1000:1000:ctf:/home/ctf:/bin/sh&quot;</span> &gt;&gt; etc/passwd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;root:x:0:&quot;</span> &gt; etc/group</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ctf:x:1000:&quot;</span> &gt;&gt; etc/group</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;none /dev/pts devpts gid=5,mode=620 0 0&quot;</span> &gt; etc/fstab</span><br></pre></td></tr></table></figure></div>

<h3 id="（三）打包文件系统"><a href="#（三）打包文件系统" class="headerlink" title="（三）打包文件系统"></a>（三）打包文件系统</h3><p>这里提供三种不同的格式： <code>qcow2</code> 、 <code>ext4</code> 、 <code>cpio</code></p>
<p><strong>QCOW2格式</strong></p>
<p>QEMU Copy-on-Write version 2 <code>QCOW2</code> 是 QEMU 的一种常用的硬盘镜像格式，我们可以使用如下命令创建一个指定大小的 QCOW2 镜像文件（<strong>创建一个 8MB 的空白虚拟磁盘，这是虚拟机启动需要的”硬盘”，但现在是空的</strong>）：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 rootfs.qcow2 8M</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 12:59:37</span><br><span class="line">╰─ qemu-img create -f qcow2 rootfs.qcow2 8M</span><br><span class="line">Formatting <span class="string">&#x27;rootfs.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=8388608 lazy_refcounts=off refcount_bits=16</span><br></pre></td></tr></table></figure></div>

<p>之后我们可以通过如下命令将其挂载为网络块设备（**将镜像文件虚拟成硬盘设备，让 Linux 系统能像操作真实硬盘一样操作镜像文件，就像把 U盘插入电脑，系统识别为 <code>/dev/sdb</code>**）：</p>
<blockquote>
<p>在此之前你可能需要手动启用如下内核模块：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> modprobe nbd</span><br></pre></td></tr></table></figure></div>
</blockquote>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> qemu-nbd -c /dev/nbd0 ./rootfs.qcow2</span><br></pre></td></tr></table></figure></div>

<p>然后将其格式化为自己想要的文件系统，例如最常用的 ext4（<strong>在虚拟硬盘上创建 ext4 文件系统，没有文件系统的硬盘无法存储文件，类似新买的 U盘需要格式化才能用</strong>）：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mkfs.ext4 /dev/nbd0</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 13:01:42</span><br><span class="line">╰─ <span class="built_in">sudo</span> mkfs.ext4 /dev/nbd0</span><br><span class="line">mke2fs 1.47.0 (5-Feb-2023)</span><br><span class="line">Discarding device blocks: <span class="keyword">done</span></span><br><span class="line">Creating filesystem with 2048 4k blocks and 2048 inodes</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span></span><br><span class="line">Writing inode tables: <span class="keyword">done</span></span><br><span class="line">Creating journal (1024 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br></pre></td></tr></table></figure></div>

<p>之后就是常规的挂载（<strong>将格式化好的文件系统挂载到 <code>/mnt</code>，通过 <code>/mnt</code>目录访问和修改虚拟硬盘内容，类似Windows 中打开”我的电脑”访问 U盘</strong>）：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mount /dev/nbd0 /mnt</span><br></pre></td></tr></table></figure></div>

<p>然后把前面我们构建的文件系统内容拷贝进去（<strong>将预先准备好的根文件系统复制到镜像中，让虚拟硬盘包含完整的操作系统文件</strong>）：</p>
<ul>
<li>root:root：系统文件需要 root 权限</li>
<li>chmod 700 &#x2F;mnt&#x2F;root：保护 root 家目录</li>
<li>1000:1000：设置 ctf 用户权限</li>
</ul>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -auv _install/* /mnt</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R root:root /mnt</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 700 /mnt/root</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R 1000:1000 /mnt/home/ctf/</span><br></pre></td></tr></table></figure></div>

<p>最后常规卸载并解绑 nbd 即可：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> umount /mnt</span><br><span class="line"><span class="built_in">sync</span></span><br><span class="line"><span class="built_in">sudo</span> qemu-nbd -d /dev/nbd0</span><br></pre></td></tr></table></figure></div>

<p>优点：</p>
<ol>
<li>方便扩展（qemu-img resize）</li>
<li>快照功能（开发测试）</li>
<li>动态空间（节省存储）</li>
<li>支持多种特性（压缩、加密）</li>
</ol>
<p>适用：</p>
<ul>
<li>虚拟机系统盘</li>
<li>开发测试环境</li>
<li>需要频繁修改的系统</li>
</ul>
<p><strong>ext4镜像格式</strong></p>
<p>这里也可以将文件系统打包为 ext4 镜像格式，首先创建空白 ext4 镜像文件，这里 <code>bs</code> 表示块大小，<code>count</code> 表示块的数量：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=rootfs.img bs=1M count=32</span><br></pre></td></tr></table></figure></div>

<p>将其格式化为 ext4 格式</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 rootfs.img </span><br></pre></td></tr></table></figure></div>

<p>挂载镜像，将文件拷贝进去即可：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> tmp</span><br><span class="line"><span class="built_in">sudo</span> mount rootfs.img ./tmp/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -rfp _install/* ./tmp/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R root:root ./tmp/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 700 ./tmp/root</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R 1000:1000 ./tmp/home/ctf/</span><br><span class="line"><span class="built_in">sudo</span> umount ./tmp</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:45:14</span><br><span class="line">╰─ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=rootfs.img bs=1M count=32</span><br><span class="line">32+0 records <span class="keyword">in</span></span><br><span class="line">32+0 records out</span><br><span class="line">33554432 bytes (34 MB, 32 MiB) copied, 0.0573243 s, 585 MB/s</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:47:39</span><br><span class="line">╰─ mkfs.ext4 rootfs.img</span><br><span class="line">mke2fs 1.47.0 (5-Feb-2023)</span><br><span class="line">Discarding device blocks: <span class="keyword">done</span></span><br><span class="line">Creating filesystem with 8192 4k blocks and 8192 inodes</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span></span><br><span class="line">Writing inode tables: <span class="keyword">done</span></span><br><span class="line">Creating journal (1024 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:47:48</span><br><span class="line">╰─ <span class="built_in">mkdir</span> tmp</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:48:01</span><br><span class="line">╰─ <span class="built_in">sudo</span> mount rootfs.img ./tmp</span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> user:</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:48:13</span><br><span class="line">╰─ <span class="built_in">sudo</span> <span class="built_in">cp</span> -rfp ../busybox-1.36.0/_install/* ./tmp</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:48:30</span><br><span class="line">╰─ <span class="built_in">sudo</span> <span class="built_in">chown</span> -R root:root ./tmp/</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:48:42</span><br><span class="line">╰─ <span class="built_in">sudo</span> <span class="built_in">chmod</span> 700 ./tmp/root</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:48:52</span><br><span class="line">╰─ <span class="built_in">sudo</span> <span class="built_in">chown</span> -R 1000:1000 ./tmp/home/ctf</span><br><span class="line"></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────░▒▓ ✔  base Py  at 00:49:05</span><br><span class="line">╰─ <span class="built_in">sudo</span> umount ./tmp</span><br></pre></td></tr></table></figure></div>

<p>优点：</p>
<ol>
<li>直接写入物理设备</li>
<li>无需中间转换</li>
<li>通用兼容性好</li>
<li>性能接近原生</li>
</ol>
<p>适用：</p>
<ul>
<li>SD卡镜像</li>
<li>USB启动盘</li>
<li>物理设备部署</li>
<li>简单测试环境</li>
</ul>
<p><strong>cpio镜像格式</strong></p>
<p>在 <code>_install</code> 目录下使用如下命令打包文件系统为 cpio 格式</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br></pre></td></tr></table></figure></div>

<p>也可以这么写</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . | cpio -o -H newc &gt; ../rootfs.cpio</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>位置是随便选的，可以将之放到自己喜欢的位置</p>
</blockquote>
<p>还可以使用如下的命令重新解包文件系统</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idv &lt; ./rootfs.cpio</span><br></pre></td></tr></table></figure></div>
<p>优点：</p>
<ol>
<li>内核直接支持</li>
<li>启动速度最快</li>
<li>无需磁盘驱动</li>
<li>最小化部署</li>
</ol>
<p>适用：</p>
<ul>
<li>initrd&#x2F;initramfs</li>
<li>系统修复盘</li>
<li>内核调试环境</li>
<li>资源受限系统</li>
</ul>
<table>
<thead>
<tr>
<th>特性</th>
<th>QCOW2</th>
<th>ext4 镜像</th>
<th>cpio</th>
</tr>
</thead>
<tbody><tr>
<td><strong>主要用途</strong></td>
<td>虚拟机硬盘镜像</td>
<td>磁盘分区镜像</td>
<td>初始内存文件系统</td>
</tr>
<tr>
<td><strong>文件系统</strong></td>
<td>可包含任何（如ext4）</td>
<td>必须是ext4</td>
<td>无文件系统概念</td>
</tr>
<tr>
<td><strong>存储方式</strong></td>
<td>稀疏文件，写时复制</td>
<td>原始二进制镜像</td>
<td>归档格式</td>
</tr>
<tr>
<td><strong>可修改性</strong></td>
<td>方便修改和扩展</td>
<td>修改需挂载</td>
<td>解包→修改→重打包</td>
</tr>
<tr>
<td><strong>压缩支持</strong></td>
<td>内置压缩</td>
<td>无，需外部压缩</td>
<td>可外部gzip压缩</td>
</tr>
<tr>
<td><strong>启动方式</strong></td>
<td>QEMU硬盘启动</td>
<td>QEMU硬盘启动</td>
<td>内核initrd启动</td>
</tr>
<tr>
<td><strong>典型大小</strong></td>
<td>几百MB-几十GB</td>
<td>几MB-几GB</td>
<td>几MB-几十MB</td>
</tr>
</tbody></table>
<h2 id="五、运行环境搭建"><a href="#五、运行环境搭建" class="headerlink" title="五、运行环境搭建"></a>五、运行环境搭建</h2><p>QEMU 是一款开源的虚拟机软件，支持多种不同架构的模拟（Emulation）以及配合 kvm 完成当前架构的虚拟化（Virtualization）的特性，是当前最火热的开源虚拟机软件。</p>
<p>通过apt安装</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新软件包列表</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 QEMU 完整套件</span></span><br><span class="line"><span class="built_in">sudo</span> apt install qemu-system qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager</span><br></pre></td></tr></table></figure></div>

<h3 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h3><p><code>boot.sh</code></p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.cpio \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet kaslr&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -smp cores=2,threads=1 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><code>-m</code>：虚拟机内存大小</p>
</li>
<li><p><code>-kernel</code>：内核镜像路径</p>
</li>
<li><p><code>-initrd</code>：初始文件系统路径，cpio 文件系统会被载入到内存当中（initramfs）</p>
</li>
<li><p><code>-monitor</code>：将监视器重定向到主机设备 <code>/dev/null</code>，这里重定向至 null 主要是防止CTF 中被人通过监视器直接拿 flag</p>
</li>
<li><p><code>-append</code>：附加参数选项</p>
<ul>
<li><code>kaslr</code>：开启内核地址随机化，你也可以改为 <code>nokaslr</code> 进行关闭以方便我们进行调试</li>
<li><code>rdinit</code>：指定初始启动进程，这里我们指定了 <code>/sbin/init</code> 作为初始进程，其会默认以 <code>/etc/init.d/rcS</code> 作为启动脚本</li>
<li><code>loglevel=3</code> &amp; <code>quiet</code>：不输出log</li>
<li><code>console=ttyS0</code>：指定终端为 <code>/dev/ttyS0</code>，这样一启动就能进入终端界面</li>
</ul>
</li>
<li><p><code>-cpu</code>：设置CPU选项，在这里开启了smep保护</p>
</li>
<li><p><code>-smp</code>：设置对称多处理器配置，这里设置了两个核心，每个核心一个线程</p>
</li>
<li><p><code>-nographic</code>：不提供图形化界面，此时内核仅有串口输出，输出内容会被 QEMU 重定向至我们的终端</p>
</li>
<li><p><code>-s</code>：相当于<code>-gdb tcp::1234</code>的简写（也可以直接这么写），后续我们可以通过gdb连接本地端口进行调试</p>
</li>
</ul>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -cpu kvm64,+smep,+smap \</span><br><span class="line">    -smp cores=2,threads=2 \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -hda ./rootfs.img \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 root=/dev/sda rw rdinit=/sbin/init kaslr pti=on quiet oops=panic panic=1&quot;</span> \</span><br><span class="line">    -no-reboot \</span><br><span class="line">	-s</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>-hda</code>：我们将 ext4 镜像挂载为一个真正的硬盘设备，优点在于更贴近真实环境（同时 flag 不会被在内存中泄漏），缺点在于所有对文件系统的操作都会“落盘”</li>
<li><code>-append</code>：我们修改了 <code>root=/dev/sda rw</code> ，因为 ext4 镜像被挂载为一个 SATA 硬盘，而 Linux 中第一个 SATA 硬盘的路径为 <code>/dev/sda</code> ，因此我们将根文件系统路径指向设备路径，并给予可读写权限</li>
</ul>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -hda ./rootfs.qcow2 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda rw rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet kaslr&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -smp cores=2,threads=1 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>-hda</code>：文件系统路径，我们将 qcow2 镜像挂载为一个真正的硬盘设备，优点在于更贴近真实环境。</li>
<li><code>-snapshot</code>：使用快照的方式启动，这样在虚拟机当中对文件系统的修改不会 “落盘”。</li>
</ul>
<h3 id="共享文件夹"><a href="#共享文件夹" class="headerlink" title="共享文件夹"></a>共享文件夹</h3><p>查看编译的内核是否支持9p共享文件夹</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">╭─ ~/kernel_modules/src ▓▒░─────────────────────────────────────────────░▒▓ 1 ✘  base Py  at 21:13:05</span><br><span class="line">╰─ grep -E <span class="string">&quot;9P|VIRTIO&quot;</span> ../../kernels/linux-6.18/linux-6.18/.config</span><br><span class="line">CONFIG_NET_9P=y</span><br><span class="line">CONFIG_NET_9P_FD=y</span><br><span class="line">CONFIG_NET_9P_VIRTIO=y</span><br></pre></td></tr></table></figure></div>

<p>qemu的核心启动参数</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-fsdev <span class="built_in">local</span>,<span class="built_in">id</span>=&lt;<span class="built_in">id</span>&gt;,path=&lt;宿主机路径&gt;,security_model=&lt;安全模式&gt;</span><br><span class="line">-device virtio-9p-pci,fsdev=&lt;fsdev_id&gt;,mount_tag=&lt;挂载标签&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本示例</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -fsdev <span class="built_in">local</span>,<span class="built_in">id</span>=fsdev0,path=/home/user/kernel_modules,security_model=none \</span><br><span class="line">    -device virtio-9p-pci,fsdev=fsdev0,mount_tag=hostshare \</span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># 参数含义    </span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    <span class="comment"># 1. 文件系统后端设备</span></span><br><span class="line">    -fsdev \</span><br><span class="line">        <span class="built_in">local</span>,                           <span class="comment"># 使用本地文件系统</span></span><br><span class="line">        <span class="built_in">id</span>=fsdev0,                       <span class="comment"># 设备ID，任意名称</span></span><br><span class="line">        path=/home/user/kernel_modules,  <span class="comment"># 宿主机共享目录路径</span></span><br><span class="line">        security_model=none,             <span class="comment"># 安全模式：none|mapped|passthrough</span></span><br><span class="line">        <span class="built_in">readonly</span>=off,                    <span class="comment"># 是否只读</span></span><br><span class="line">        multidevs=remap                  <span class="comment"># 处理重复文件名</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 9p虚拟设备</span></span><br><span class="line">    -device \</span><br><span class="line">        virtio-9p-pci,                   <span class="comment"># 设备类型</span></span><br><span class="line">        fsdev=fsdev0,                    <span class="comment"># 引用fsdev的ID</span></span><br><span class="line">        mount_tag=hostshare              <span class="comment"># 客户机中看到的挂载标签</span></span><br></pre></td></tr></table></figure></div>

<p>-fsdev参数选项</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>local</code></td>
<td>固定</td>
<td>使用本地文件系统后端</td>
</tr>
<tr>
<td><code>id</code></td>
<td>自定义名称</td>
<td>设备标识符，如 <code>fsdev0</code>, <code>sharedir</code></td>
</tr>
<tr>
<td><code>path</code></td>
<td>宿主机路径</td>
<td>要共享的目录，如 <code>/home/user/shared</code></td>
</tr>
<tr>
<td><code>security_model</code></td>
<td><code>none</code></td>
<td>不进行权限映射，客户机以 root 运行</td>
</tr>
<tr>
<td></td>
<td><code>mapped</code></td>
<td>尝试映射 uid&#x2F;gid，推荐使用</td>
</tr>
<tr>
<td></td>
<td><code>passthrough</code></td>
<td>直接传递权限，需要特权</td>
</tr>
<tr>
<td><code>readonly</code></td>
<td><code>on</code>&#x2F;<code>off</code></td>
<td>是否只读，默认 <code>off</code></td>
</tr>
<tr>
<td><code>multidevs</code></td>
<td><code>remap</code></td>
<td>重命名重复文件</td>
</tr>
<tr>
<td></td>
<td><code>forbid</code></td>
<td>禁止重复文件（默认）</td>
</tr>
<tr>
<td></td>
<td><code>warn</code></td>
<td>警告但允许</td>
</tr>
</tbody></table>
<p>-device参数选项</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>virtio-9p-pci</code></td>
<td>固定</td>
<td>使用 virtio 9p PCI 设备</td>
</tr>
<tr>
<td><code>fsdev</code></td>
<td>fsdev的id</td>
<td>必须与 <code>-fsdev</code>的 id 一致</td>
</tr>
<tr>
<td><code>mount_tag</code></td>
<td>自定义标签</td>
<td>客户机挂载时使用的标签，如 <code>hostshare</code></td>
</tr>
<tr>
<td><code>bus</code></td>
<td>如 <code>pci.0</code></td>
<td>PCI 总线位置</td>
</tr>
<tr>
<td><code>addr</code></td>
<td>如 <code>0x6</code></td>
<td>PCI 设备地址</td>
</tr>
</tbody></table>
<p>在客户机内挂载</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户机内执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /mnt/host <span class="comment">#名字自取</span></span><br><span class="line">mount -t 9p -o trans=virtio,version=9p2000.L ShareDIR /mnt/host <span class="comment"># ShareDIR是之前设置过的mount_tag</span></span><br><span class="line"></span><br><span class="line">~ <span class="comment"># mkdir -p /mnt/host</span></span><br><span class="line">~ <span class="comment"># mount -t 9p -o trans=virtio,version=9p2000.L ShareDIR /mnt/host</span></span><br><span class="line">~ <span class="comment"># ls /mnt/host/</span></span><br><span class="line">~ <span class="comment">#</span></span><br><span class="line">╭─ ~/busyboxs/filesystems ▓▒░─────────────────────────────────────────────────────░▒▓ ✔  base Py  at 21:37:26</span><br><span class="line">╰─ <span class="built_in">touch</span> ../../../user/kernels/linux-6.18/ShareDIR/123</span><br><span class="line">~ <span class="comment"># ls /mnt/host/</span></span><br><span class="line">123</span><br><span class="line">~ <span class="comment">#</span></span><br></pre></td></tr></table></figure></div>



<h2 id="六、可装载内核模块开发"><a href="#六、可装载内核模块开发" class="headerlink" title="六、可装载内核模块开发"></a>六、可装载内核模块开发</h2><blockquote>
<p>参考arttnba3师傅的博客：<a class="link" target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/#0x04-%E7%BC%96%E5%86%99%E5%8F%AF%E8%A3%85%E8%BD%BD%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%EF%BC%88LKMs%EF%BC%89">【OS.0x01】Linux Kernel II：内核简易食用指北 - arttnba3’s blog<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<h3 id="基本内核模块"><a href="#基本内核模块" class="headerlink" title="基本内核模块"></a>基本内核模块</h3><p>我们首先写一个基础的内核模块，源码文件结构组织如下：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ tree .</span><br><span class="line">.</span><br><span class="line">├── Makefile</span><br><span class="line">└── src</span><br><span class="line">    ├── Kbuild</span><br><span class="line">    └── main.c</span><br><span class="line"></span><br><span class="line">2 directories, 3 files</span><br></pre></td></tr></table></figure></div>

<p>main.c 的内容如下，其定义了一个初始化函数<code>a3kmod_init()</code> ，该函数会在模块载入时被调用，同时其定义了一个退出函数 <code>a3kmod_exit()</code> ，该函数会在模块被卸载时被调用：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __init <span class="type">int</span> <span class="title function_">a3kmod_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[a3kmod:] Hello kernel world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __exit <span class="type">void</span> <span class="title function_">a3kmod_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[a3kmod:] Goodbye kernel world!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(a3kmod_init);</span><br><span class="line">module_exit(a3kmod_exit);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;arttnba3&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL v2&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>linux/module.h</code>：对于LKM而言这是必须包含的一个头文件</li>
<li><code>linux/kernel.h</code>：载入内核相关信息</li>
<li><code>linux/init.h</code>：包含着一些有用的宏</li>
<li><code>__init</code> 与 <code>__exit</code> 宏：用来显式标识内核模块出入口函数</li>
<li><code>MODULE_AUTHOR() &amp; MODULE_LICENSE()</code>：声明内核作者与发行所用许可证</li>
</ul>
<hr>
<p><code>kbuild</code> 是 <code>Linux kernel</code> 构建系统的一部分，简而言之，当我们在源码目录下编写了 <code>Kbuild</code> 文件之后，在编译时 <code>Linux kernel</code> 的编译基础设施便会根据 <code>Kbuild</code> 来自动地编译好我们的内核模块，若没有 <code>Kbuild</code> 则会选择寻找 <code>Makefile</code> 。</p>
<p>最基础的 Kbuild 文件的示例：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># module name</span></span><br><span class="line">MODULE_NAME ?= a3kmod</span><br><span class="line">obj-m += $(MODULE_NAME).o</span><br><span class="line"></span><br><span class="line"><span class="comment"># compiler flags</span></span><br><span class="line">ccflags-y += -I$(src)/include</span><br><span class="line"></span><br><span class="line"><span class="comment"># entry point</span></span><br><span class="line">$(MODULE_NAME)-y += main.o</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>MODULE_NAME</code> ：一个简单的自定义变量，我们用来定义我们的模块名。</li>
<li><code>obj-m</code> ：这个符号用来指定要被编译的内核模块列表，<code>+=</code> 意味着添加上我们的内核模块，而 <code>$(MODULE_NAME).o</code> 则是我们的内核模块编译的后期产物，这通常由单个或多个目标文件合并而成，最后会被链接为 <code>$(MODULE_NAME).ko</code> 文件，也就是我们所熟悉的 LKM ELF；如果要将模块编译进内核 ELF 文件（vmlinux）中，则应当使用 <code>obj-y</code>。</li>
<li><code>ccflags-y</code> ：<code>ccflags</code> 意味着编译选项，<code>-y</code> 意味着开启的编译选项，这里我们添加了 <code>-I</code> 选项以引入我们自己的头文件目录（只是作为示范，本节实际上不涉及复杂代码结构），更多编译选项可以参见 <a class="link" target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Invoking-GCC.html">GCC 的文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</li>
<li><code>$(MODULE_NAME)-y</code> ：<code>$(MODULE_NAME).o</code>所需要的目标文件，<code>-y</code> 意味着编译过程需要该文件，这里我们加入了一个 <code>main.o</code> ，意味着我们的源码目录下应当有一个 <code>main.c</code>。</li>
</ul>
<p>由于我们已经在 Kbuild 当中指示了模块的构建行为，我们只需要在源码根目录的 Makefile 当中写入通用性内容，这里我们的 Makefile 写入如下：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SPDX-License-Identifier: GPL-2.0</span></span><br><span class="line"><span class="comment"># Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span></span><br><span class="line"></span><br><span class="line">A3KMOD_ROOT_DIR=$(shell <span class="built_in">pwd</span>)</span><br><span class="line">A3KMOD_SRC_DIR=$(A3KMOD_ROOT_DIR)/src</span><br><span class="line">LINUX_KERNEL_SRC=/lib/modules/$(shell <span class="built_in">uname</span> -r)/build</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">        @$(MAKE) -C $(LINUX_KERNEL_SRC) M=$(A3KMOD_SRC_DIR) modules</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">        @$(MAKE) -C $(LINUX_KERNEL_SRC) M=$(A3KMOD_SRC_DIR) clean</span><br><span class="line"></span><br><span class="line">.PHONY: clean</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>LINUX_KERNEL_SRC := /lib/modules/$(shell uname -r)/build</code> ：当前系统所使用的内核源码路径</li>
<li><code>make -C $(LINUX_KERNEL_SRC) M=$(CURRENT_PATH) modules</code>：<code>-C</code> 表示进入源码目录进行编译，<code>M=</code> 意味着当前正在编译一个外部模块、该变量用以指示外部模块的源码目录， <code>modules</code> 则意为进行内核模块编译操作</li>
<li><code>make -C $(LINUX_KERNEL_SRC) M=$(CURRENT_PATH) clean</code>：同上，不过此时进行的是清理指令</li>
</ul>
<p>然后就可以通过<code>make -j$(nproc) all</code>来编译内核模块了</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">╭─ ~/kernel_modules ▓▒░───────────────────────────────────────────────────░▒▓ ✔  base Py  at 21:11:09</span><br><span class="line">╰─ make all</span><br><span class="line">make[1]: Entering directory <span class="string">&#x27;/home/user/kernels/linux-6.18/linux-6.18&#x27;</span></span><br><span class="line">make[2]: Entering directory <span class="string">&#x27;/home/user/kernel_modules/src&#x27;</span></span><br><span class="line">  MODPOST Module.symvers</span><br><span class="line">WARNING: modpost: missing MODULE_DESCRIPTION() <span class="keyword">in</span> kernelmodule.o</span><br><span class="line">  CC [M]  kernelmodule.mod.o</span><br><span class="line">  CC [M]  .module-common.o</span><br><span class="line">  LD [M]  kernelmodule.ko</span><br><span class="line">make[2]: Leaving directory <span class="string">&#x27;/home/user/kernel_modules/src&#x27;</span></span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/home/user/kernels/linux-6.18/linux-6.18&#x27;</span></span><br><span class="line"></span><br><span class="line">╭─ ~/kernel_modules ▓▒░───────────────────────────────────────────────────░▒▓ ✔  base Py  at 21:11:17</span><br><span class="line">╰─ <span class="built_in">ls</span></span><br><span class="line">Makefile  src</span><br><span class="line"></span><br><span class="line">╭─ ~/kernel_modules ▓▒░───────────────────────────────────────────────────░▒▓ ✔  base Py  at 21:11:20</span><br><span class="line">╰─ <span class="built_in">ls</span> src</span><br><span class="line">Kbuild          kernelmodule.ko   kernelmodule.mod.c  kernelmodule.o  main.o</span><br><span class="line">Module.symvers  kernelmodule.mod  kernelmodule.mod.o  main.c          modules.order</span><br></pre></td></tr></table></figure></div>

<p>在编译内核模块之前，你还需要在内核源码目录下先执行该命令：</p>
<ul>
<li><code>$ make -j$(nproc) modules</code></li>
</ul>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">╭─ ~/kernels/linux-6.18/linux-6.18 ▓▒░────────────────────────────────────░▒▓ ✔  base Py  at 21:09:13</span><br><span class="line">╰─ make -j$(<span class="built_in">nproc</span>) modules</span><br><span class="line">  DESCEND objtool</span><br><span class="line">  CALL    scripts/checksyscalls.sh</span><br><span class="line">  INSTALL libsubcmd_headers</span><br><span class="line">  LDS     scripts/module.lds</span><br><span class="line">  CC [M]  net/netfilter/nf_log_syslog.o</span><br><span class="line">  CC [M]  net/netfilter/xt_mark.o</span><br><span class="line">  CC [M]  net/netfilter/xt_LOG.o</span><br><span class="line">  CC [M]  drivers/thermal/intel/x86_pkg_temp_thermal.o</span><br><span class="line">  CC [M]  net/netfilter/xt_MASQUERADE.o</span><br><span class="line">  CC [M]  net/netfilter/xt_addrtype.o</span><br><span class="line">  CC [M]  net/ipv6/netfilter/nf_reject_ipv6.o</span><br><span class="line">  CC [M]  net/ipv4/netfilter/nf_reject_ipv4.o</span><br><span class="line">  CC [M]  fs/efivarfs/inode.o</span><br><span class="line">  CC [M]  fs/efivarfs/file.o</span><br><span class="line">  CC [M]  fs/efivarfs/super.o</span><br><span class="line">  CC [M]  fs/efivarfs/vars.o</span><br><span class="line">  LD [M]  fs/efivarfs/efivarfs.o</span><br><span class="line">  MODPOST Module.symvers</span><br><span class="line">  CC [M]  fs/efivarfs/efivarfs.mod.o</span><br><span class="line">  CC [M]  .module-common.o</span><br><span class="line">  CC [M]  drivers/thermal/intel/x86_pkg_temp_thermal.mod.o</span><br><span class="line">  CC [M]  net/netfilter/nf_log_syslog.mod.o</span><br><span class="line">  CC [M]  net/netfilter/xt_mark.mod.o</span><br><span class="line">  CC [M]  net/netfilter/xt_LOG.mod.o</span><br><span class="line">  CC [M]  net/netfilter/xt_MASQUERADE.mod.o</span><br><span class="line">  CC [M]  net/netfilter/xt_addrtype.mod.o</span><br><span class="line">  CC [M]  net/ipv4/netfilter/nf_reject_ipv4.mod.o</span><br><span class="line">  CC [M]  net/ipv6/netfilter/nf_reject_ipv6.mod.o</span><br><span class="line">  LD [M]  net/ipv6/netfilter/nf_reject_ipv6.ko</span><br><span class="line">  LD [M]  drivers/thermal/intel/x86_pkg_temp_thermal.ko</span><br><span class="line">  LD [M]  net/netfilter/nf_log_syslog.ko</span><br><span class="line">  LD [M]  fs/efivarfs/efivarfs.ko</span><br><span class="line">  LD [M]  net/ipv4/netfilter/nf_reject_ipv4.ko</span><br><span class="line">  LD [M]  net/netfilter/xt_mark.ko</span><br><span class="line">  LD [M]  net/netfilter/xt_LOG.ko</span><br><span class="line">  LD [M]  net/netfilter/xt_MASQUERADE.ko</span><br><span class="line">  LD [M]  net/netfilter/xt_addrtype.ko</span><br></pre></td></tr></table></figure></div>

<p>注意，缩进<code>tab</code>长度为8个空格，如果不是则会报：</p>
<ul>
<li><code>Makefile:8: *** missing separator.  Stop.</code></li>
</ul>
<p>现在加载内核模块（我通过9p共享文件夹传入）</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># insmod /mnt/host/kernelmodule.ko</span></span><br><span class="line">~ <span class="comment"># rmmod kernelmodule</span></span><br><span class="line">~ <span class="comment"># dmesg | grep a3k</span></span><br><span class="line">[  422.173235] [a3kmod:] Hello kernel world!</span><br><span class="line">[  424.828648] [a3kmod:] Goodbye kernel world!</span><br><span class="line">~ <span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

<h3 id="提供用户态接口"><a href="#提供用户态接口" class="headerlink" title="提供用户态接口"></a>提供用户态接口</h3><blockquote>
<p><a class="link" target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II">【OS.0x01】Linux Kernel II：内核简易食用指北 - arttnba3’s blog<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<p><em>NIX&#x2F;Linux的哲学之一便是<code>万物皆文件</code>，*<em>一切都可以被抽象为文件，一切都可以使用访问文件的方式进行操作</em></em></p>
<p>我们若是想要能够与我们的内核模块进行交互，则同样可以通过文件进行——注册一个“虚拟设备节点”，随后我们的用户态程序便可以使用系统调用<code>read、write、ioctl</code>来完成与内核模块间的通信</p>
<h4 id="设备注册"><a href="#设备注册" class="headerlink" title="设备注册"></a>设备注册</h4><ul>
<li><p>设备分类</p>
<ul>
<li><p><code>字符设备</code>：在I&#x2F;O传输过程中<strong>以字符为单位</strong>进行传输的设备，例如键盘、串口等。字符设备<strong>按照字符流的方式被有序访问，不能够进行随机读取</strong></p>
</li>
<li><p><code>块设备</code>：在块设备中，信息被存储在固定大小的块中，每个块有着自己的地址，例如硬盘、SD卡等。用户可以对块设备进行<strong>随机访问——从任意位置读取一定长度的数据</strong></p>
</li>
</ul>
</li>
<li><p><code>file_operations</code>结构体</p>
<ul>
<li>在注册设备之前，我们需要用到一个结构体——<code>file_operations</code>来完成对设备的一些相关定义，该结构体定义于<code>include/linux/fs.h</code>中，在其中定义了大量的函数指针</li>
<li>一个文件应当拥有一个<code>file_operations实例</code>，并指定相关系统调用函数指针所指向的自定义函数，在后续进行设备的注册时会使用该结构体</li>
</ul>
</li>
<li><p>主设备号 &amp; 次设备号</p>
<ul>
<li>在Linux内核中，使用类型<code>dev_t</code>（unsigned long）来标识一个设备的设备号。一个字符的设备号由<code>主设备号</code>与<code>次设备号</code>组成，高字节存储主设备号，低字节存储次设备号：<ul>
<li><code>主设备号</code>：标识设备类型，使用宏<code>MAJOR(dev_t dev)</code>可以获取主设备号</li>
<li><code>次设备号</code>：用以区分同类型设备，使用宏<code>MINOR(dev_t dev)</code>可以获取次设备号</li>
</ul>
</li>
<li>Linux还提供了一个宏<code> MKDEV(int major, int minor);</code>，用以通过主次设备号生成对应的设备号</li>
</ul>
</li>
<li><p>设备节点（struct device_node &amp; struct device）</p>
<ul>
<li>基于“万物皆文件”的设计思想，Linux中所有的设备都以文件的形式进行访问，这些文件存放在<code>/dev</code>目录下，一个文件就是一个<strong>设备节点</strong></li>
<li>在Linux kernel中使用结构体<code>device</code>描述一个设备，该结构体定义于<code>include/linux/device.h</code>（内核源码路径）中，<strong>每个设备在内核中都有着其对应的device实例，其中记录着设备的相关信息</strong></li>
<li>在DTS（Device Tree Source，设备树）中则使用<code>device_node</code>结构体表示一个设备</li>
</ul>
</li>
<li><p>设备类（struct class）</p>
<ul>
<li>在Linux kernel中使用结构体<code>class</code>用以表示<strong>高层次抽象的设备</strong>，该结构体定义于<code>include/linux/device/class.h</code>中</li>
<li>每个设备节点实例中都应当包含着一个指向相应设备类实例的指针</li>
</ul>
</li>
<li><p>设备的注册与注销</p>
<ul>
<li>使用由内核提供的函数<code>register_chrdev(unsigned int major, const char *name, const struct file_operations *fops)</code>进行字符型设备注册，该函数定义于<code>include/linux/fs.h</code>，会将注册成功后的主设备号返回，若失败则会返回一个负值，参数说明如下：<ul>
<li>major：主设备号，若为0则由内核分配主设备号</li>
<li>name：设备名，由用户指定</li>
<li>fops：该设备的文件操作系统（file_operations结构体）指针</li>
</ul>
</li>
<li>使用宏<code>class_create(owner, name)</code>创建<strong>设备类</strong>，该宏定义于<code>include/linux/device.h</code>中，其核心调用函数是<code>__class_create(struct module *owner, const char *name, struct lock_class_key *key)</code></li>
<li>使用函数<code>device_create(struct class *cls, struct device *parent, dev_t devt, void *drvdata, const char *fmt, ...)</code><strong>创建设备节点</strong>，若成功则最终会在<code>/dev</code>目录下生成我们的设备节点文件，各参数说明如下：<ul>
<li>cls：该设备的设备类</li>
<li>parent：该设备的父设备节点，通常情况下应当为某种总线或主机控制器，若该设备为顶级设备则设为NULL</li>
<li>devt：该设备的设备号</li>
<li>drvdata：该驱动的相关信息，若无则填NULL</li>
<li>fmt：设备名称</li>
</ul>
</li>
<li>设备的注销则是逆着上面的进程进行，同样有着相对应的三个函数：<code>device_destroy(struct class *cls, dev_t devt)</code>、<code>class_destroy(struct class *cls)</code>、<code>unregister_chrdev(unsigned int major, const char *name)</code></li>
<li>需要注意的是<strong>若是注册设备的进程中的某一步出错了，我们在退出内核态函数之前应当手动调用注销函数清理原先的相关资源</strong></li>
</ul>
</li>
<li><p>设备权限</p>
<ul>
<li><p>内核模块运行在内核空间，所创建的设备节点只有root用户才有权限进行读写，对于其他用户而言便毫无意义，这并不是我们想要的，因此我们需要通过进一步的设置使得所有用户都有权限通过设备节点文件与我们的内核模块进行交互</p>
<p>在内核中使用<code>inode</code>结构体表示一个文件，该结构体定义于<code>include/linux/fs.h</code>中，其中用以标识权限的是成员<code>i_mode</code></p>
<p>而在内核中对于使用<code>flip_open()</code>打开的文件，Linux内核中使用 <code>file</code> 结构体进行描述，该结构体定义于<code>include/linux/fs.h</code>中，其中有着指向内核中该文件的 inode 实例的指针，使用<code>file_inode()</code>函数可以获得一个 file 结构体中的 inode 结构体指针</p>
<p>那么我们不难想到，若是在内核模块中使用<code>file_open()</code>函数打开我们的设备节点文件，随后修改 file 结构体中的 inode 指针指向的 inode 实例的 i_mode 成员，便能够修改该文件的权限</p>
<blockquote>
<p>需要注意的是rwx三个权限位仅占3位，因而应当使用八进制进行操作：<code>__inode-&gt;i_mode |= 0666;</code>，而不是16进制</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* arttnba3_module.ko</span></span><br><span class="line"><span class="comment">* developed by arttnba3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">&quot;a3device&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_PATH <span class="string">&quot;/dev/a3device&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLASS_NAME <span class="string">&quot;a3module&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major_num;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> * <span class="title">module_class</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> * <span class="title">module_device</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> * __<span class="title">file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> * __<span class="title">inode</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">a3_module_fo</span> =</span> </span><br><span class="line">&#123;</span><br><span class="line">    .owner = THIS_MODULE</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">kernel_module_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Module loaded. Start to register device...\n&quot;</span>);</span><br><span class="line">    major_num = register_chrdev(<span class="number">0</span>, DEVICE_NAME, &amp;a3_module_fo);</span><br><span class="line">    <span class="keyword">if</span> (major_num &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Failed to register a major number.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> major_num;</span><br><span class="line">    &#125;    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Register complete, major number: %d\n&quot;</span>, major_num);</span><br><span class="line"></span><br><span class="line">    module_class = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_class))</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Failed to register class device!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_class);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Class device register complete.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    module_device = device_create(module_class, <span class="literal">NULL</span>, MKDEV(major_num, <span class="number">0</span>), <span class="literal">NULL</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_device))</span><br><span class="line">    &#123;</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Failed to create the device!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_device);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Module register complete.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    __file = filp_open(DEVICE_PATH, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(__file))</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Unable to change module privilege!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(__file);</span><br><span class="line">    &#125;</span><br><span class="line">    __inode = file_inode(__file);</span><br><span class="line">    __inode-&gt;i_mode |= <span class="number">0666</span>;</span><br><span class="line">    filp_close(__file, <span class="literal">NULL</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Module privilege change complete.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">kernel_module_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Start to clean up the module.\n&quot;</span>);</span><br><span class="line">    device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">    class_destroy(module_class);</span><br><span class="line">    unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[arttnba3_TestModule:] Module clean up complete. See you next time.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(kernel_module_init);</span><br><span class="line">module_exit(kernel_module_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;arttnba3&quot;</span>);</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>接下来我们只要为内核模块编写相应的API，便可以在用户态应用程式上通过虚拟设备&#x2F;dev&#x2F;a3device完成与内核模块间的通信</p>
</li>
</ul>
</li>
</ul>
<h4 id="编写系统调用接口"><a href="#编写系统调用接口" class="headerlink" title="编写系统调用接口"></a>编写系统调用接口</h4><blockquote>
<p>参考：<a class="link" target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/#II-%E7%BC%96%E5%86%99%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0">【OS.0x01】Linux Kernel II：内核简易食用指北 - arttnba3’s blog<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<h4 id="测试模块接口"><a href="#测试模块接口" class="headerlink" title="测试模块接口"></a>测试模块接口</h4><blockquote>
<p>参考：<a class="link" target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/#III-%E6%B5%8B%E8%AF%95%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%8F%A3">【OS.0x01】Linux Kernel II：内核简易食用指北 - arttnba3’s blog<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<h3 id="procfs接口"><a href="#procfs接口" class="headerlink" title="procfs接口"></a>procfs接口</h3><p>除了创建虚拟设备节点供通信以外，我们也可以选择创建虚拟文件节点的方式与用户进程间进行通信</p>
<blockquote>
<p>procfs（进程文件系统，Process file system ）是一个虚拟文件系统，通常挂载在&#x2F;proc目录，它允许内核向用户空间导出信息，也允许用户空间通过文件操作（如read、write）与内核交互。用户空间程序可以像操作普通文件一样操作这个文件，比如用cat命令读取内容，用echo写入内容。实际上，这些操作会触发内核模块中定义的函数。</p>
</blockquote>
<p>内核模块与用户空间交互的常见方式：</p>
<ul>
<li>procfs：简单，适合少量数据，常用于内核调试和状态报告。</li>
<li>sysfs：用于设备模型，通常用于设备驱动。</li>
<li>字符设备：更通用，可以实现更复杂的操作（如ioctl）。</li>
<li>netlink：用于网络相关，支持异步通信。</li>
<li>其他：如debugfs、sysctl等。</li>
</ul>
<p>接下来我们为我们的内核模块添加可供用户态应用程序交互的方式，一个比较常见的方式是我们的内核模块在载入后创建一个虚拟文件节点，用户态应用程序打开该节点后通过 <code>read()</code> 、 <code>write()</code> 、 <code>ioctl()</code> 等系统调用进行交互。</p>
<p>本节我们简单创建一个可供用户态交互的 procfs （ Process file system ）的文件节点。</p>
<h4 id="预备编程知识"><a href="#预备编程知识" class="headerlink" title="预备编程知识"></a>预备编程知识</h4><p>内核中有很多错误码，要注意 <code>EINVAL</code> 和其他错误码的边界：</p>
<table>
<thead>
<tr>
<th align="center">错误码</th>
<th align="center">含义</th>
<th align="center">区别于 <code>-EINVAL</code> 的场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>-EFAULT</code></td>
<td align="center">地址错误</td>
<td align="center">参数是用户态指针，但指向非法内存（如 <code>copy_to_user</code> 失败）</td>
</tr>
<tr>
<td align="center"><code>-ENOMEM</code></td>
<td align="center">内存不足</td>
<td align="center">内核分配内存失败（如 <code>kmalloc</code> 返回 NULL）</td>
</tr>
<tr>
<td align="center"><code>-EBADF</code></td>
<td align="center">非法文件描述符</td>
<td align="center">传入的 fd 不是打开的有效文件描述符</td>
</tr>
<tr>
<td align="center"><code>-EINVAL</code></td>
<td align="center">无效参数</td>
<td align="center">参数格式 &#x2F; 范围 &#x2F; 语义非法，但地址 &#x2F; 内存等无问题</td>
</tr>
</tbody></table>
<h4 id="proc-ops结构体"><a href="#proc-ops结构体" class="headerlink" title="proc_ops结构体"></a>proc_ops结构体</h4><p>类似于<code>file_operations</code>结构体，不同的是该结构体被用于procfs。定义于<code>include/linux/proc_fs.h</code>中，仅定义了少量函数指针成员</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> proc_flags;</span><br><span class="line">    <span class="type">int</span> (*proc_open)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">ssize_t</span> (*proc_read)(<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*proc_read_iter)(<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">    <span class="type">ssize_t</span> (*proc_write)(<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="comment">/* mandatory unless nonseekable_open() or equivalent is used */</span></span><br><span class="line">    <span class="type">loff_t</span>  (*proc_lseek)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*proc_release)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">__poll_t</span> (*proc_poll)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *);</span><br><span class="line">    <span class="type">long</span>    (*proc_ioctl)(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">    <span class="type">long</span>    (*proc_compat_ioctl)(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">int</span> (*proc_mmap)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*proc_get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure></div>

<h4 id="创建虚拟文件夹"><a href="#创建虚拟文件夹" class="headerlink" title="创建虚拟文件夹"></a>创建虚拟文件夹</h4><p>使用<code>proc_mkdir(const char *, struct proc_dir_entry *)</code>函数可以快速创建虚拟文件夹，第一个参数用以指定文件夹名，第二个参数用以指定该文件夹挂载于哪个procfs节点下，若为NULL则自动挂载到<code>/proc</code>目录下</p>
<p>该函数的返回值为<code>proc_dir_entry</code>类型的指针，该结构体定义于<code>fs/proc/internal.h</code>中，我们可以通过这个结构体指针管理我们的虚拟文件</p>
<h4 id="创建虚拟文件节点"><a href="#创建虚拟文件节点" class="headerlink" title="创建虚拟文件节点"></a>创建虚拟文件节点</h4><p>使用<code>proc_create(const char *name, umode_t mode, struct proc_dir_entry *parent, const struct proc_ops *proc_ops)</code>函数可以快速创建一个文件节点</p>
<ul>
<li><code>name</code>：文件名</li>
<li><code>mode</code>：文件读写执行权限</li>
<li><code>parent</code>：该文件挂载的procfs节点，若为NULL则自动挂载到<code>/proc</code>目录下</li>
<li><code>proc_ops</code>：该文件的proc_ops结构体</li>
</ul>
<p>该函数的返回值同样为<code>proc_dir_entry</code>类型的指针</p>
<h4 id="注销虚拟文件节点"><a href="#注销虚拟文件节点" class="headerlink" title="注销虚拟文件节点"></a>注销虚拟文件节点</h4><p>函数<code>remove_proc_entry(const char *, struct proc_dir_entry *)</code>用以注销此前创建的文件，其中第一个参数为文件名，第二个参数为其挂载的节点，若为NULL则默认为<code>/proc</code>目录</p>
<h4 id="文件节点交互"><a href="#文件节点交互" class="headerlink" title="文件节点交互"></a>文件节点交互</h4><p>我们的文件节点支持通过 <code>read()</code> 、 <code>write()</code> 、 <code>ioctl()</code> 等系统调用进行交互，而这实际上需要我们在内核空间当中定义相应的操作函数。对于 procfs 而言，其支持的操作通过 <code>struct proc_ops</code> 这一函数表进行定义：</p>
<p>这里我们简单地为 <code>proc_read()</code> 与 <code>proc_write()</code> 实现对应的函数原型，其功能为拷贝数据到用户进程以及从用户进程读取数据，并将函数指针放入我们的 <code>proc_ops</code> 中：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> A3KMOD_BUF_SZ 0x1000</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> a3kmod_buf[A3KMOD_BUF_SZ] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">a3kmod_proc_read</span></span><br><span class="line"><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *ppos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ssize_t</span> err;</span><br><span class="line">    <span class="type">size_t</span> end_loc, copied;</span><br><span class="line">    end_loc = size + (*ppos);</span><br><span class="line">    <span class="keyword">if</span> (end_loc &lt; size || (*ppos) &gt; A3KMOD_BUF_SZ) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (end_loc &gt; A3KMOD_BUF_SZ) &#123;</span><br><span class="line">        end_loc = A3KMOD_BUF_SZ;</span><br><span class="line">    &#125;</span><br><span class="line">    copied = end_loc - (*ppos);</span><br><span class="line">    <span class="keyword">if</span> (copied == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;   <span class="comment">// EOF</span></span><br><span class="line">    &#125;</span><br><span class="line">    err = copy_to_user(ubuf, &amp;a3kmod_buf[*ppos], copied);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    *ppos = end_loc;</span><br><span class="line">    <span class="keyword">return</span> copied;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">a3kmod_proc_write</span></span><br><span class="line"><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *ppos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ssize_t</span> err;</span><br><span class="line">    <span class="type">size_t</span> end_loc, copied;</span><br><span class="line">    end_loc = size + (*ppos);</span><br><span class="line">    <span class="keyword">if</span> (end_loc &lt; size || (*ppos) &gt; A3KMOD_BUF_SZ) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (end_loc &gt; A3KMOD_BUF_SZ) &#123;</span><br><span class="line">        end_loc = A3KMOD_BUF_SZ;</span><br><span class="line">    &#125;</span><br><span class="line">    copied = end_loc - (*ppos);</span><br><span class="line">    <span class="keyword">if</span> (copied == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;   <span class="comment">// EOF</span></span><br><span class="line">    &#125;</span><br><span class="line">    err = copy_from_user(&amp;a3kmod_buf[*ppos], ubuf, copied);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    *ppos = end_loc;</span><br><span class="line">    <span class="keyword">return</span> copied;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">a3kmod_proc_ops</span> =</span> &#123;</span><br><span class="line">    .proc_read = a3kmod_proc_read,</span><br><span class="line">    .proc_write = a3kmod_proc_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<h4 id="创建文件节点"><a href="#创建文件节点" class="headerlink" title="创建文件节点"></a>创建文件节点</h4><p>在模块初始化函数中调用 <code>proc_create()</code> 创建我们的 procfs 文件节点，各个参数分别指定了节点名、权限、父节点（为 NULL 则挂到 procfs 的根节点）、函数表，并在模块卸载时销毁该节点：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static struct proc_dir_entry *a3kmod_proc_dir_entry;</span><br><span class="line"></span><br><span class="line">static __init int a3kmod_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[a3kmod:] Hello kernel world!\n&quot;</span>);</span><br><span class="line">    a3kmod_proc_dir_entry = proc_create(<span class="string">&quot;a3kmod&quot;</span>, 0666, NULL, &amp;a3kmod_proc_ops);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(a3kmod_proc_dir_entry)) &#123;</span><br><span class="line">        <span class="built_in">return</span> PTR_ERR(a3kmod_proc_dir_entry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static __exit void a3kmod_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[a3kmod:] Goodbye kernel world!\n&quot;</span>);</span><br><span class="line">    proc_remove(a3kmod_proc_dir_entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p><code>main.c</code></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_PROC_NAME <span class="string">&quot;my_proc_node&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_BUF_SIZE 1024</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> my_buffer[MY_BUF_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">my_proc_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *user_buf, <span class="type">size_t</span> count, <span class="type">loff_t</span> *ppos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> end_loc, copy_size;</span><br><span class="line">    <span class="type">ssize_t</span> err;</span><br><span class="line">    <span class="keyword">if</span>(*ppos &gt; MY_BUF_SIZE)<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    end_loc = count + (*ppos);</span><br><span class="line">    <span class="keyword">if</span>(end_loc &lt; count || end_loc &lt; (*ppos))<span class="keyword">return</span> -EINVAL;</span><br><span class="line">    end_loc = end_loc &lt;= MY_BUF_SIZE ? end_loc:MY_BUF_SIZE;</span><br><span class="line"></span><br><span class="line">    copy_size = end_loc - (*ppos);</span><br><span class="line">    <span class="keyword">if</span>(!copy_size) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    err = copy_to_user(user_buf,&amp;my_buffer[*ppos],copy_size);</span><br><span class="line">    <span class="keyword">if</span>(err)<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    *ppos = end_loc;</span><br><span class="line">    <span class="keyword">return</span> copy_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">my_proc_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *user_buf, <span class="type">size_t</span> count, <span class="type">loff_t</span> *ppos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> end_loc, copy_size;</span><br><span class="line">    <span class="type">ssize_t</span> err;</span><br><span class="line">    <span class="keyword">if</span>(*ppos &gt; MY_BUF_SIZE)<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    end_loc = count + (*ppos);</span><br><span class="line">    <span class="keyword">if</span>(end_loc &lt; count || end_loc &lt; (*ppos))<span class="keyword">return</span> -EINVAL;</span><br><span class="line">    end_loc = end_loc &lt;= MY_BUF_SIZE ? end_loc:MY_BUF_SIZE;</span><br><span class="line"></span><br><span class="line">    copy_size = end_loc - (*ppos);</span><br><span class="line">    <span class="keyword">if</span>(!copy_size) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    err = copy_from_user(&amp;my_buffer[*ppos],user_buf,copy_size);</span><br><span class="line">    <span class="keyword">if</span>(err)<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    *ppos = end_loc;</span><br><span class="line">    <span class="keyword">return</span> copy_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">my_proc_ops</span> =</span> &#123;</span><br><span class="line">    .proc_read = my_proc_read,</span><br><span class="line">    .proc_write = my_proc_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __init <span class="type">int</span> <span class="title function_">mykmod_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">proc_entry</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建/proc/my_proc_node节点</span></span><br><span class="line">    proc_entry = proc_create(MY_PROC_NAME, <span class="number">0666</span>, <span class="literal">NULL</span>, &amp;my_proc_ops);</span><br><span class="line">    <span class="keyword">if</span> (!proc_entry) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to create proc entry %s\n&quot;</span>, MY_PROC_NAME);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;my_proc_module loaded: /proc/%s created\n&quot;</span>, MY_PROC_NAME);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __exit <span class="type">void</span> <span class="title function_">mykmod_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    remove_proc_entry(MY_PROC_NAME, <span class="literal">NULL</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;my_proc_module unloaded: /proc/%s removed\n&quot;</span>, MY_PROC_NAME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(mykmod_init);</span><br><span class="line">module_exit(mykmod_exit);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;n3rds&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL v2&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<p><code>Makefile</code></p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MYMODULE_ROOT_PATH = $(shell <span class="built_in">pwd</span>)</span><br><span class="line">MYMODULE_SRC_PATH = $(MYMODULE_ROOT_PATH)/src</span><br><span class="line">LINUX_KERNEL_SRC_PATH = /home/user/kernels/linux-6.18/linux-6.18</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">	@$(MAKE) -C $(LINUX_KERNEL_SRC_PATH) M=$(MYMODULE_SRC_PATH) modules</span><br><span class="line">clean:</span><br><span class="line">	@$(MAKE) -C $(LINUX_KERNEL_SRC_PATH) M=$(MYMODULE_SRC_PATH) clean</span><br></pre></td></tr></table></figure></div>

<p><code>Kbuild</code></p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># moudule_name</span></span><br><span class="line">MODULE_NAME ?= myModule</span><br><span class="line">obj-m += $(MODULE_NAME).o</span><br><span class="line"></span><br><span class="line"><span class="comment"># compiler flags</span></span><br><span class="line">ccflags-y += -I/$(src)/include</span><br><span class="line"></span><br><span class="line"><span class="comment"># entry point</span></span><br><span class="line">$(MODULE_NAME)-y += main.o</span><br></pre></td></tr></table></figure></div>

<h2 id="内核调试"><a href="#内核调试" class="headerlink" title="内核调试"></a>内核调试</h2><h3 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>qemu启动时可以设置<code>-gdb tcp::1234</code>（简写<code>-s</code>）在1234端口开放<code>gdbserver</code></p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -hda  ./rootfs.img \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda rw rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet nokaslr&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -smp cores=2,threads=1 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure></div>

<p><code>gdb</code>连接：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -q -ex <span class="string">&quot;target remote localhost:1234&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>符号信息添加</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /sys/module/a3kmod/sections/.text </span></span><br><span class="line">0xffffffffc008f000</span><br><span class="line"><span class="comment"># cat /sys/module/a3kmod/sections/.data </span></span><br><span class="line">0xffffffffc0091038</span><br><span class="line"><span class="comment"># cat /sys/module/a3kmod/sections/.bss</span></span><br><span class="line">0xffffffffc0091540</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; add-symbol-file ./test_kmod/src/a3kmod.ko -s .text 0xffffffffc008f000 -s .data 0xffffffffc0091038 -s .bss 0xffffffffc0091540</span><br><span class="line">add symbol table from file <span class="string">&quot;./test_kmod/src/a3kmod.ko&quot;</span> at</span><br><span class="line">        .text_addr = 0xffffffffc008f000</span><br><span class="line">        .data_addr = 0xffffffffc0091038</span><br><span class="line">        .bss_addr = 0xffffffffc0091540</span><br><span class="line">Reading symbols from ./test_kmod/src/a3kmod.ko...</span><br><span class="line">warning: remote target does not support file transfer, attempting to access files from <span class="built_in">local</span> filesystem.</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./test_kmod/src/a3kmod.ko)</span><br></pre></td></tr></table></figure></div>

<h3 id="kgdb调试"><a href="#kgdb调试" class="headerlink" title="kgdb调试"></a>kgdb调试</h3><p>内核提供了专门的调试工具：KGDB（Kernel GNU Debugger），我们可以通过在编译时启用 <code>CONFIG_KGDB=y</code> 配置选项来将 KGDB 组件编译到内核当中，并使用串口等方式进行调试。</p>
<p>在 QEMU 模拟环境中，我们可以通过指定一个串口（例如 <code>ttyS1</code> ）为 KGDB 提供输出，例如考虑如下启动脚本：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 kgdboc=ttyS1,115200 oops=panic panic=1 nokaslr&quot;</span> \</span><br><span class="line">    -smp cores=2,threads=1 \</span><br><span class="line">    -display none \</span><br><span class="line">    -serial stdio \</span><br><span class="line">    -serial tcp::4445,server,nowait \</span><br><span class="line">    -cpu kvm64</span><br></pre></td></tr></table></figure></div>

<ul>
<li>我们为内核的启动参数添加了 <code>console=ttyS0 kgdboc=ttyS1,</code> ，为将串口 <code>ttyS0</code> 指定为控制台输出，将串口 <code>ttyS1</code> 指定为 KGDB 调试端口。</li>
<li>我们为 QEMU 启动参数添加了两个 <code>-serial</code> 参数，意为创建了两个串口，其中第一个串口指定为标准输入输出，第二个串口指定为本地 4445 端口。</li>
</ul>
<p>可以在 qemu 虚拟机内部通过执行 <code>echo g &gt; /proc/sysrq-trigger</code> 命令触发 KGDB</p>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> Linux Kernel PWN</li>
        <li><strong>作者:</strong> HackC0der</li>
        <li><strong>创建于
                :</strong> 2025-12-29 20:48:39</li>
        
            <li>
                <strong>更新于
                    :</strong> 2026-01-18 13:24:38
            </li>
        
        <li>
            <strong>链接:</strong> https://hackc0der.github.io/2025/12/29/Linux-Kernel-PWN（一）基础知识/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

		</div>
		

		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/12/21/2025RCTF-mstr/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">2025RCTF-mstr</span>
						<span class="post-nav-item">下一篇</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        评论
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          dark: 'body[class~="dark-mode"]',
          reaction: false,
          requiredMeta: ['nick', 'mail'],
          emoji: [],
                    lang: 'zh-CN',
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">目录</div>
		<div class="page-title">Linux Kernel PWN</div>
		<ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">一、基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E7%89%B9%E6%9D%83%E7%BA%A7%E5%88%87%E6%8D%A2"><span class="nav-text">（一）特权级切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4"><span class="nav-text">（二）虚拟内存空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E8%BF%9B%E7%A8%8B%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="nav-text">（三）进程权限管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89Loadable-Kernel-Modules-LKMs"><span class="nav-text">（四）Loadable Kernel Modules(LKMs)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%BA%94%EF%BC%89%E5%86%85%E6%A0%B8%E4%BA%A4%E4%BA%92"><span class="nav-text">（五）内核交互</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E5%85%AD%EF%BC%89%E5%86%85%E6%A0%B8%E6%80%81%E5%B8%B8%E8%A7%81%E5%87%BD%E6%95%B0"><span class="nav-text">（六）内核态常见函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%83%EF%BC%89%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="nav-text">（七）缓解措施</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Kernel-PWN-%E9%A2%98%E5%9E%8B"><span class="nav-text">二、Kernel PWN 题型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E5%B8%B8%E8%A7%84%E9%A2%98%E7%9B%AE%E6%96%87%E4%BB%B6"><span class="nav-text">（一）常规题目文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E8%BF%9C%E7%A8%8B%E4%B8%8A%E4%BC%A0"><span class="nav-text">（二）远程上传</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">三、环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81"><span class="nav-text">（一）内核源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E5%86%85%E6%A0%B8%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81"><span class="nav-text">（二）内核签名验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9"><span class="nav-text">（三）编译选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="nav-text">（四）编译内核</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%BA%94%EF%BC%89%E4%B8%8B%E8%BD%BD%E5%86%85%E6%A0%B8"><span class="nav-text">（五）下载内核</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA%EF%BC%88BusyBox%EF%BC%89"><span class="nav-text">四、文件系统构建（BusyBox）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E4%B8%8B%E8%BD%BD%E7%BC%96%E8%AF%91BusyBox"><span class="nav-text">（一）下载编译BusyBox</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-text">（二）配置文件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E6%89%93%E5%8C%85%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-text">（三）打包文件系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">五、运行环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="nav-text">启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="nav-text">共享文件夹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%8F%AF%E8%A3%85%E8%BD%BD%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91"><span class="nav-text">六、可装载内核模块开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97"><span class="nav-text">基本内核模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E4%BE%9B%E7%94%A8%E6%88%B7%E6%80%81%E6%8E%A5%E5%8F%A3"><span class="nav-text">提供用户态接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#procfs%E6%8E%A5%E5%8F%A3"><span class="nav-text">procfs接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95"><span class="nav-text">内核调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb%E8%B0%83%E8%AF%95"><span class="nav-text">gdb调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kgdb%E8%B0%83%E8%AF%95"><span class="nav-text">kgdb调试</span></a></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2025</span>
              -
            
            2026&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">HackC0der</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        共撰写了 4 篇文章
                    </span>
                    
                        <span>
                            共 35.3k 字
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">访问人数</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">总访问量</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>





    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>











    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





	
</body>

</html>